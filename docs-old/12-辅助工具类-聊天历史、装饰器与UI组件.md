# è¾…åŠ©å·¥å…·ç±» - èŠå¤©å†å²ã€è£…é¥°å™¨ä¸UIç»„ä»¶

> **æœ¬è®²ç›®æ ‡**ï¼šæŒæ¡ç”Ÿäº§çº§è¾…åŠ©å·¥å…·ç±»çš„å®ç°ï¼Œæå‡ä»£ç è´¨é‡å’Œç”¨æˆ·ä½“éªŒ

## ä¸€ã€è¾…åŠ©å·¥å…·çš„é‡è¦æ€§

åœ¨å®é™…çš„ç”Ÿæˆåº”ç”¨ä¸­ä¼šæ¶‰åŠå¤§é‡è¾…åŠ©åŠŸèƒ½ï¼Œæœ¬è®²ä¸»è¦å¸¦é¢†å¤§å®¶å®ç°æœ¬ç³»ç»Ÿæ¶‰åŠçš„å·¥å…·ç±»ã€‚

**ä¸‰å¤§è¾…åŠ©å·¥å…·ç±»**ï¼š

| å·¥å…·ç±» | ä½œç”¨ | ä»£ç è¡Œæ•° | æ ¸å¿ƒä»·å€¼ |
|-------|------|---------|---------|
| **ChatHistoryManager** | èŠå¤©è®°å½•ç®¡ç† | 379è¡Œ | æŒä¹…åŒ–ã€å¯¼å‡ºã€ç»Ÿè®¡ |
| **decorators** | è£…é¥°å™¨å·¥å…·é›† | 334è¡Œ | é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ |
| **UIComponents** | UIç»„ä»¶å°è£… | 384è¡Œ | ç»Ÿä¸€ç•Œé¢é£æ ¼ã€ç®€åŒ–è°ƒç”¨ |

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å·¥å…·ï¼Ÿ**

```
æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆAgentã€LLMã€Vector Storeï¼‰
           â†“
è¾…åŠ©å·¥å…·ï¼ˆèŠå¤©å†å²ã€è£…é¥°å™¨ã€UIç»„ä»¶ï¼‰
           â†“
ç”Ÿäº§çº§åº”ç”¨ï¼ˆç¨³å®šã€æ˜“ç”¨ã€å¯ç›‘æ§ï¼‰
```

- **èŠå¤©å†å²**ï¼šç”¨æˆ·æœŸæœ›å¯¹è¯è¢«ä¿å­˜ã€å¯å¯¼å‡ºã€å¯æœç´¢
- **è£…é¥°å™¨**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§
- **UIç»„ä»¶**ï¼šç»Ÿä¸€Streamlitç»„ä»¶é£æ ¼ï¼Œç®€åŒ–app.pyä»£ç 

## äºŒã€æ–‡ä»¶ç»“æ„æ¦‚è§ˆ

æˆ‘ä»¬æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼ˆå…±1097è¡Œï¼‰ï¼š

1. **chat_history.pyï¼ˆ379è¡Œï¼‰**ï¼š
   - CRUDæ“ä½œï¼ˆæ·»åŠ ã€æŸ¥è¯¢ã€åˆ é™¤ã€æ¸…ç©ºï¼‰
   - å¯¼å‡ºåŠŸèƒ½ï¼ˆCSVã€JSONï¼‰
   - æœç´¢å’Œç»Ÿè®¡
   - å¤‡ä»½å’Œæ¢å¤

2. **decorators.pyï¼ˆ334è¡Œï¼‰**ï¼š
   - `error_handler`ï¼šå¼‚å¸¸æ•è·å’ŒUIå±•ç¤º
   - `log_execution`ï¼šæ‰§è¡Œæ—¥å¿—è®°å½•
   - `performance_monitor`ï¼šæ€§èƒ½ç›‘æ§
   - `retry_on_failure`ï¼šå¤±è´¥é‡è¯•
   - `cache_result`ï¼šç»“æœç¼“å­˜

3. **ui_components.pyï¼ˆ384è¡Œï¼‰**ï¼š
   - æ¨¡å‹å’Œå‚æ•°é€‰æ‹©å™¨
   - RAGè®¾ç½®é¢æ¿
   - æ–‡ä»¶ä¸Šä¼ å™¨
   - èŠå¤©è®°å½•å±•ç¤º
   - ç»Ÿè®¡å’Œå¯¼å‡ºç•Œé¢

## ä¸‰ã€æ ¸å¿ƒä»£ç è®²è§£

ç”±äºä»£ç é‡è¾ƒå¤§ï¼Œæˆ‘ä»¬é‡ç‚¹è®²è§£æ¯ä¸ªå·¥å…·ç±»çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

### ç¬¬ä¸€éƒ¨åˆ†ï¼šèŠå¤©å†å²ç®¡ç†ï¼ˆchat_history.pyæ ¸å¿ƒåŠŸèƒ½ï¼‰
**ä»£ç æ–‡ä»¶ï¼š** `study-agentic-rag/03-smart-qa-application/utils/chat_history.py`


**æ ¸å¿ƒèŒè´£**ï¼šæŒä¹…åŒ–èŠå¤©è®°å½•ã€å¯¼å‡ºã€æœç´¢ã€ç»Ÿè®¡

<details>
<summary>ç‚¹å‡»å±•å¼€æ ¸å¿ƒä»£ç ï¼ˆCRUD + å¯¼å‡ºï¼‰</summary>

```python
import json
import os
import csv
import logging
from typing import List, Dict, Optional, Any
from datetime import datetime
from pathlib import Path
from config.settings import Settings

logger = logging.getLogger(__name__)

class ChatHistoryManager:
    """èŠå¤©è®°å½•ç®¡ç†å™¨"""

    def __init__(self, history_file: str = None):
        """åˆå§‹åŒ–èŠå¤©è®°å½•ç®¡ç†å™¨
        
        æ–¹æ³•ç”¨é€”ï¼šåˆ›å»ºChatHistoryManagerå®ä¾‹ï¼Œè®¾ç½®å†å²æ–‡ä»¶è·¯å¾„ï¼ŒåŠ è½½ç°æœ‰è®°å½•
        
        å‚æ•°è§£é‡Šï¼š
            history_file (str, å¯é€‰): å†å²è®°å½•æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºNoneåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤è·¯å¾„
            
        è¿”å›å€¼ï¼šæ— ï¼ˆæ„é€ å‡½æ•°ï¼‰
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> # ä½¿ç”¨é»˜è®¤è·¯å¾„
            >>> manager = ChatHistoryManager()
            >>> print(manager.history_file)  # è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤è·¯å¾„
            >>> 
            >>> # ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„
            >>> custom_manager = ChatHistoryManager('my_chat_history.json')
            >>> print(custom_manager.history_file)  # è¿”å›: 'my_chat_history.json'
            >>> 
            >>> # è‡ªåŠ¨åˆ›å»ºç›®å½•
            >>> manager = ChatHistoryManager('data/chats/history.json')
            >>> # å¦‚æœdata/chatsç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
        """
        self.settings = Settings()
        self.history_file = history_file or self.settings.CHAT_HISTORY_PATH
        self.history_dir = Path(self.history_file).parent
        self.history_dir.mkdir(parents=True, exist_ok=True)
        self.chat_history = []
        self.max_history_size = 10000  # æœ€å¤§å†å²è®°å½•æ•°

        # åŠ è½½ç°æœ‰å†å²è®°å½•
        self.load_history()

    def add_message(self, role: str, content: str, metadata: Dict[str, Any] = None) -> bool:
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šå°†ä¸€æ¡æ–°çš„èŠå¤©æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•ä¸­ï¼Œå¹¶è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
        
        å‚æ•°è§£é‡Šï¼š
            role (str): æ¶ˆæ¯è§’è‰²ï¼Œå¦‚ 'user', 'assistant', 'system'
            content (str): æ¶ˆæ¯å†…å®¹
            metadata (Dict[str, Any], å¯é€‰): æ¶ˆæ¯çš„å…ƒæ•°æ®ï¼Œå¦‚æ¨¡å‹ä¿¡æ¯ã€æ¸©åº¦ç­‰
            
        è¿”å›å€¼ï¼š
            bool: æ·»åŠ æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> success = manager.add_message('user', 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Python')
            >>> print(success)  # è¿”å›: True
            
            >>> success = manager.add_message('assistant', 'Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€...', 
            ...                                {'model': 'gpt-4', 'temperature': 0.7})
            >>> print(success)  # è¿”å›: True
        """
        try:
            message = {
                "role": role,
                "content": content,
                "timestamp": datetime.now().isoformat(),
                "id": self._generate_message_id()
            }

            if metadata:
                message["metadata"] = metadata

            self.chat_history.append(message)

            # å¦‚æœè¶…è¿‡æœ€å¤§æ•°é‡ï¼Œç§»é™¤æœ€æ—§çš„è®°å½•
            if len(self.chat_history) > self.max_history_size:
                self.chat_history.pop(0)

            # ä¿å­˜åˆ°æ–‡ä»¶
            self.save_history()

            logger.debug(f"æ·»åŠ æ¶ˆæ¯æˆåŠŸ: {role}")
            return True

        except Exception as e:
            logger.error(f"æ·»åŠ æ¶ˆæ¯å¤±è´¥: {str(e)}")
            return False

    def get_history(self, limit: int = None, role_filter: str = None) -> List[Dict[str, Any]]:
        """è·å–å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šè·å–èŠå¤©è®°å½•ï¼Œæ”¯æŒæŒ‰è§’è‰²è¿‡æ»¤å’Œæ•°é‡é™åˆ¶
        
        å‚æ•°è§£é‡Šï¼š
            limit (int, å¯é€‰): è¿”å›çš„æœ€å¤§è®°å½•æ•°ï¼ŒNoneè¡¨ç¤ºè¿”å›æ‰€æœ‰è®°å½•
            role_filter (str, å¯é€‰): è§’è‰²è¿‡æ»¤å™¨ï¼Œå¦‚ 'user', 'assistant'ï¼ŒNoneè¡¨ç¤ºä¸è¿‡æ»¤
            
        è¿”å›å€¼ï¼š
            List[Dict[str, Any]]: æ¶ˆæ¯åˆ—è¡¨ï¼Œæ¯æ¡æ¶ˆæ¯åŒ…å«roleã€contentã€timestampã€idç­‰å­—æ®µ
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½')
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ')
            >>> 
            >>> # è·å–æ‰€æœ‰å†å²è®°å½•
            >>> all_history = manager.get_history()
            >>> print(len(all_history))  # è¿”å›: 2
            >>> 
            >>> # è·å–æœ€è¿‘1æ¡è®°å½•
            >>> recent = manager.get_history(limit=1)
            >>> print(recent[0]['role'])  # è¿”å›: 'assistant'
            >>> 
            >>> # åªè·å–ç”¨æˆ·æ¶ˆæ¯
            >>> user_msgs = manager.get_history(role_filter='user')
            >>> print(len(user_msgs))  # è¿”å›: 1
        """
        try:
            history = self.chat_history.copy()

            # è§’è‰²è¿‡æ»¤
            if role_filter:
                history = [msg for msg in history if msg.get("role") == role_filter]

            # æ•°é‡é™åˆ¶
            if limit and limit > 0:
                history = history[-limit:]

            return history

        except Exception as e:
            logger.error(f"è·å–å†å²è®°å½•å¤±è´¥: {str(e)}")
            return []

    def clear_history(self) -> bool:
        """æ¸…ç©ºå†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šæ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ï¼Œå¹¶åˆ é™¤ä¿å­˜çš„å†å²æ–‡ä»¶
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: æ¸…ç©ºæˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½')
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼')
            >>> print(len(manager.get_history()))  # è¿”å›: 2
            >>> 
            >>> # æ¸…ç©ºå†å²è®°å½•
            >>> success = manager.clear_history()
            >>> print(success)  # è¿”å›: True
            >>> print(len(manager.get_history()))  # è¿”å›: 0
        """
        try:
            self.chat_history = []
            self.save_history()

            logger.info("æ¸…ç©ºå†å²è®°å½•æˆåŠŸ")
            return True

        except Exception as e:
            logger.error(f"æ¸…ç©ºå†å²è®°å½•å¤±è´¥: {str(e)}")
            return False

    def export_to_csv(self, output_file: str = None) -> str:
        """å¯¼å‡ºä¸ºCSVæ ¼å¼
        
        æ–¹æ³•ç”¨é€”ï¼šå°†èŠå¤©è®°å½•å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼Œå¯ä»¥è¿”å›CSVå­—ç¬¦ä¸²æˆ–ä¿å­˜åˆ°æ–‡ä»¶
        
        å‚æ•°è§£é‡Šï¼š
            output_file (str, å¯é€‰): è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºNoneåˆ™è¿”å›CSVå­—ç¬¦ä¸²
            
        è¿”å›å€¼ï¼š
            str: å¦‚æœoutput_fileä¸ºNoneï¼Œè¿”å›CSVå­—ç¬¦ä¸²ï¼›å¦åˆ™è¿”å›æ–‡ä»¶è·¯å¾„
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½', {'model': 'gpt-4'})
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ')
            >>> 
            >>> # å¯¼å‡ºä¸ºCSVå­—ç¬¦ä¸²
            >>> csv_content = manager.export_to_csv()
            >>> print(csv_content[:50])  # è¿”å›: 'role,content,timestamp,id,metadata\\r\\nuser,ä½ å¥½,...'
            >>> 
            >>> # ä¿å­˜åˆ°æ–‡ä»¶
            >>> file_path = manager.export_to_csv('chat_history.csv')
            >>> print(file_path)  # è¿”å›: 'chat_history.csv'
        """
        try:
            if not output_file:
                # è¿”å›CSVå­—ç¬¦ä¸²
                import io
                output = io.StringIO()

                if self.chat_history:
                    # å®šä¹‰æ ‡å‡†CSVå­—æ®µï¼Œæ’é™¤å¤æ‚çš„metadataå­—æ®µ
                    standard_fields = ['role', 'content', 'timestamp', 'id']
                    writer = csv.DictWriter(output, fieldnames=standard_fields)
                    writer.writeheader()
                    
                    # åªå¯¼å‡ºæ ‡å‡†å­—æ®µ
                    for message in self.chat_history:
                        row = {field: message.get(field, '') for field in standard_fields}
                        writer.writerow(row)

                csv_content = output.getvalue()
                output.close()

                logger.info("å¯¼å‡ºCSVæˆåŠŸ")
                return csv_content
            else:
                # ä¿å­˜åˆ°æ–‡ä»¶
                with open(output_file, 'w', newline='', encoding='utf-8') as f:
                    if self.chat_history:
                        # å®šä¹‰æ ‡å‡†CSVå­—æ®µï¼Œæ’é™¤å¤æ‚çš„metadataå­—æ®µ
                        standard_fields = ['role', 'content', 'timestamp', 'id']
                        writer = csv.DictWriter(f, fieldnames=standard_fields)
                        writer.writeheader()
                        
                        # åªå¯¼å‡ºæ ‡å‡†å­—æ®µ
                        for message in self.chat_history:
                            row = {field: message.get(field, '') for field in standard_fields}
                            writer.writerow(row)

                logger.info(f"å¯¼å‡ºCSVæ–‡ä»¶æˆåŠŸ: {output_file}")
                return output_file

        except Exception as e:
            logger.error(f"å¯¼å‡ºCSVå¤±è´¥: {str(e)}")
            return ""

    def search_history(self, keyword: str, role_filter: str = None) -> List[Dict[str, Any]]:
        """æœç´¢å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šæ ¹æ®å…³é”®è¯æœç´¢èŠå¤©è®°å½•ï¼Œæ”¯æŒæŒ‰è§’è‰²è¿‡æ»¤
        
        å‚æ•°è§£é‡Šï¼š
            keyword (str): æœç´¢å…³é”®è¯ï¼Œä¸åŒºåˆ†å¤§å°å†™
            role_filter (str, å¯é€‰): è§’è‰²è¿‡æ»¤å™¨ï¼Œå¦‚ 'user', 'assistant'ï¼ŒNoneè¡¨ç¤ºä¸è¿‡æ»¤
            
        è¿”å›å€¼ï¼š
            List[Dict[str, Any]]: åŒ¹é…çš„æ¶ˆæ¯åˆ—è¡¨
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'Pythonæ˜¯ä»€ä¹ˆï¼Ÿ')
            >>> manager.add_message('assistant', 'Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€')
            >>> manager.add_message('user', 'Javaæ˜¯ä»€ä¹ˆï¼Ÿ')
            >>> 
            >>> # æœç´¢åŒ…å«"Python"çš„è®°å½•
            >>> results = manager.search_history('python')
            >>> print(len(results))  # è¿”å›: 2ï¼ˆç”¨æˆ·é—®é¢˜å’ŒåŠ©æ‰‹å›ç­”ï¼‰
            >>> 
            >>> # åªæœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­åŒ…å«"æ˜¯ä»€ä¹ˆ"çš„è®°å½•
            >>> user_results = manager.search_history('æ˜¯ä»€ä¹ˆ', role_filter='user')
            >>> print(len(user_results))  # è¿”å›: 2
            >>> 
            >>> # æœç´¢ä¸å­˜åœ¨çš„å…³é”®è¯
            >>> empty_results = manager.search_history('ä¸å­˜åœ¨çš„è¯')
            >>> print(len(empty_results))  # è¿”å›: 0
        """
        try:
            results = []
            keyword = keyword.lower()

            for message in self.chat_history:
                # è§’è‰²è¿‡æ»¤
                if role_filter and message.get("role") != role_filter:
                    continue

                # å†…å®¹æœç´¢
                content = message.get("content", "").lower()
                if keyword in content:
                    results.append(message)

            logger.info(f"æœç´¢å†å²è®°å½•: '{keyword}' - æ‰¾åˆ° {len(results)} æ¡ç»“æœ")
            return results

        except Exception as e:
            logger.error(f"æœç´¢å†å²è®°å½•å¤±è´¥: {str(e)}")
            return []

    def load_history(self) -> bool:
        """åŠ è½½å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šä»JSONæ–‡ä»¶åŠ è½½èŠå¤©è®°å½•åˆ°å†…å­˜ä¸­
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: åŠ è½½æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> success = manager.load_history()
            >>> print(success)  # è¿”å›: Trueï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼‰
            >>> 
            >>> # åŠ è½½åå¯ä»¥åœ¨å†…å­˜ä¸­è®¿é—®å†å²è®°å½•
            >>> history = manager.get_history()
            >>> print(len(history))  # è¿”å›å†å²è®°å½•æ•°é‡
        """
        try:
            if os.path.exists(self.history_file):
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.chat_history = json.load(f)
                logger.info(f"åŠ è½½å†å²è®°å½•æˆåŠŸ: {len(self.chat_history)} æ¡è®°å½•")
            else:
                self.chat_history = []
                logger.info("å†å²è®°å½•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨")
            return True
        except Exception as e:
            logger.error(f"åŠ è½½å†å²è®°å½•å¤±è´¥: {str(e)}")
            self.chat_history = []
            return False

    def save_history(self) -> bool:
        """ä¿å­˜å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šå°†å†…å­˜ä¸­çš„èŠå¤©è®°å½•ä¿å­˜åˆ°JSONæ–‡ä»¶
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: ä¿å­˜æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'æµ‹è¯•æ¶ˆæ¯')
            >>> success = manager.save_history()
            >>> print(success)  # è¿”å›: True
            >>> 
            >>> # ä¿å­˜åå¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çœ‹åˆ°å†å²æ–‡ä»¶
            >>> import os
            >>> print(os.path.exists(manager.history_file))  # è¿”å›: True
        """
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.chat_history, f, ensure_ascii=False, indent=2)
            logger.debug(f"ä¿å­˜å†å²è®°å½•æˆåŠŸ: {len(self.chat_history)} æ¡è®°å½•")
            return True
        except Exception as e:
            logger.error(f"ä¿å­˜å†å²è®°å½•å¤±è´¥: {str(e)}")
            return False

    def _generate_message_id(self) -> str:
        """ç”Ÿæˆæ¶ˆæ¯ID
        
        æ–¹æ³•ç”¨é€”ï¼šä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            str: 36ä½çš„UUIDå­—ç¬¦ä¸²
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> msg_id = manager._generate_message_id()
            >>> print(msg_id)  # è¿”å›: '550e8400-e29b-41d4-a716-446655440000'
            >>> print(len(msg_id))  # è¿”å›: 36
            >>> 
            >>> # æ¯æ¬¡è°ƒç”¨éƒ½ä¼šç”Ÿæˆä¸åŒçš„ID
            >>> id1 = manager._generate_message_id()
            >>> id2 = manager._generate_message_id()
            >>> print(id1 == id2)  # è¿”å›: False
        """
        import uuid
        return str(uuid.uuid4())

```

</details>

**ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Ÿ**

1. **ä¸ºä»€ä¹ˆé™åˆ¶æœ€å¤§å†å²è®°å½•æ•°ï¼Ÿ**
   ```python
   self.max_history_size = 10000
   if len(self.chat_history) > self.max_history_size:
       self.chat_history.pop(0)  # ç§»é™¤æœ€æ—§çš„
   ```
   - é˜²æ­¢æ–‡ä»¶æ— é™å¢é•¿
   - 10000æ¡è®°å½•çº¦å å‡ MBï¼ˆå¯æ¥å—ï¼‰
   - è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®

2. **ä¸ºä»€ä¹ˆæ¯æ¬¡æ·»åŠ éƒ½ä¿å­˜æ–‡ä»¶ï¼Ÿ**
   ```python
   self.chat_history.append(message)
   self.save_history()  # ç«‹å³ä¿å­˜
   ```
   - é˜²æ­¢ç¨‹åºå´©æºƒå¯¼è‡´æ•°æ®ä¸¢å¤±
   - ç”¨æˆ·æœŸæœ›å¯¹è¯è¢«å®æ—¶ä¿å­˜
   - ç£ç›˜I/Oå¼€é”€å°ï¼ˆJSONåºåˆ—åŒ–å¾ˆå¿«ï¼‰

3. **ä¸ºä»€ä¹ˆCSVå¯¼å‡ºæ”¯æŒä¸¤ç§æ¨¡å¼ï¼Ÿ**
   ```python
   if not output_file:
       return csv_content  # è¿”å›å­—ç¬¦ä¸²ï¼ˆç”¨äºst.download_buttonï¼‰
   else:
       # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆç”¨äºæœ¬åœ°å¯¼å‡ºï¼‰
   ```
   - **Streamlitæ¨¡å¼**ï¼šè¿”å›å­—ç¬¦ä¸²ï¼Œä¼ ç»™`st.download_button`
   - **å‘½ä»¤è¡Œæ¨¡å¼**ï¼šä¿å­˜åˆ°æ–‡ä»¶ï¼Œæ–¹ä¾¿è„šæœ¬è°ƒç”¨
   
4. æµ‹è¯•ChatHistoryManagerç±»

   ```python
   if __name__ == "__main__":
       """ChatHistoryManager ç±»çš„å®Œæ•´æµ‹è¯•"""
       
       import tempfile
       import os
       
       print("ğŸš€ å¼€å§‹æµ‹è¯• ChatHistoryManager ç±»...\n")
       
       # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºæµ‹è¯•
       with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as tmp_file:
           temp_history_file = tmp_file.name
       
       try:
           # 1. æµ‹è¯•åˆå§‹åŒ–
           print("ğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–ç®¡ç†å™¨")
           manager = ChatHistoryManager(history_file=temp_history_file)
           print(f"   âœ… åˆå§‹åŒ–æˆåŠŸï¼Œå†å²æ–‡ä»¶: {manager.history_file}")
           
           # 2. æµ‹è¯•æ·»åŠ æ¶ˆæ¯
           print("\nğŸ’¬ æµ‹è¯•2: æ·»åŠ æ¶ˆæ¯")
           manager.add_message("user", "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Python")
           manager.add_message("assistant", "Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œå…·æœ‰ç®€æ´æ˜“è¯»çš„è¯­æ³•ç‰¹ç‚¹ã€‚", 
                             metadata={"model": "gpt-4", "temperature": 0.7})
           manager.add_message("user", "Pythoné€‚åˆåšä»€ä¹ˆç±»å‹çš„é¡¹ç›®ï¼Ÿ")
           manager.add_message("assistant", "Pythoné€‚åˆæ•°æ®åˆ†æã€Webå¼€å‘ã€äººå·¥æ™ºèƒ½ã€è‡ªåŠ¨åŒ–è„šæœ¬ç­‰å¤šç§åº”ç”¨åœºæ™¯ã€‚",
                             metadata={"model": "gpt-5", "confidence": 0.95})
           print(f"   âœ… æˆåŠŸæ·»åŠ  {len(manager.get_history())} æ¡æ¶ˆæ¯")
           
           # 3. æµ‹è¯•è·å–å†å²è®°å½•
           print("\nğŸ“– æµ‹è¯•3: è·å–å†å²è®°å½•")
           full_history = manager.get_history()
           print(f"   âœ… è·å–å®Œæ•´å†å²: {len(full_history)} æ¡è®°å½•")
           
           user_messages = manager.get_history(role_filter="user")
           print(f"   âœ… è·å–ç”¨æˆ·æ¶ˆæ¯: {len(user_messages)} æ¡è®°å½•")
           
           assistant_messages = manager.get_history(role_filter="assistant", limit=1)
           print(f"   âœ… è·å–æœ€æ–°åŠ©æ‰‹æ¶ˆæ¯: {len(assistant_messages)} æ¡è®°å½•")
           
           # 4. æµ‹è¯•æœç´¢åŠŸèƒ½
           print("\nğŸ” æµ‹è¯•4: æœç´¢åŠŸèƒ½")
           python_results = manager.search_history("Python")
           print(f"   âœ… æœç´¢ 'Python': æ‰¾åˆ° {len(python_results)} æ¡ç»“æœ")
           
           project_results = manager.search_history("é¡¹ç›®", role_filter="user")
           print(f"   âœ… æœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ 'é¡¹ç›®': æ‰¾åˆ° {len(project_results)} æ¡ç»“æœ")
           
           no_results = manager.search_history("JavaScript")
           print(f"   âœ… æœç´¢ 'JavaScript': æ‰¾åˆ° {len(no_results)} æ¡ç»“æœ")
           
           # 5. æµ‹è¯•å¯¼å‡ºåŠŸèƒ½
           print("\nğŸ“Š æµ‹è¯•5: å¯¼å‡ºåŠŸèƒ½")
           csv_content = manager.export_to_csv()
           print(f"   âœ… å¯¼å‡ºCSVå­—ç¬¦ä¸²: {len(csv_content)} å­—ç¬¦")
           
           csv_file = temp_history_file.replace('.json', '.csv')
           csv_path = manager.export_to_csv(csv_file)
           print(f"   âœ… ä¿å­˜CSVæ–‡ä»¶: {csv_path}")
           
           # 6. æµ‹è¯•ä¿å­˜å’ŒåŠ è½½
           print("\nğŸ’¾ æµ‹è¯•6: ä¿å­˜å’ŒåŠ è½½")
           save_success = manager.save_history()
           print(f"   âœ… ä¿å­˜å†å²è®°å½•: {save_success}")
           
           # åˆ›å»ºæ–°ç®¡ç†å™¨å®ä¾‹å¹¶åŠ è½½
           new_manager = ChatHistoryManager(history_file=temp_history_file)
           load_success = new_manager.load_history()
           print(f"   âœ… åŠ è½½å†å²è®°å½•: {load_success}")
           print(f"   âœ… åŠ è½½åè®°å½•æ•°: {len(new_manager.get_history())}")
           
           # 7. æµ‹è¯•æ¸…ç©ºå†å²
           print("\nğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•")
           clear_success = new_manager.clear_history()
           print(f"   âœ… æ¸…ç©ºå†å²è®°å½•: {clear_success}")
           print(f"   âœ… æ¸…ç©ºåè®°å½•æ•°: {len(new_manager.get_history())}")
           
           # 8. æµ‹è¯•æ¶ˆæ¯IDç”Ÿæˆ
           print("\nğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ")
           msg_id = manager._generate_message_id()
           print(f"   âœ… ç”Ÿæˆæ¶ˆæ¯ID: {msg_id}")
           print(f"   âœ… IDé•¿åº¦: {len(msg_id)} å­—ç¬¦")
           
           # 9. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
           print("\nâš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ")
           empty_manager = ChatHistoryManager(history_file="non_existent_file.json")
           empty_manager.load_history()  # åº”è¯¥èƒ½å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶
           print(f"   âœ… å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶: {len(empty_manager.get_history())} æ¡è®°å½•")
           
           empty_results = empty_manager.search_history("ä»»ä½•å†…å®¹")
           print(f"   âœ… æœç´¢ç©ºå†å²: {len(empty_results)} æ¡ç»“æœ")
           
           empty_csv = empty_manager.export_to_csv()
           print(f"   âœ… å¯¼å‡ºç©ºå†å²: '{empty_csv}'")
           
           print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼ChatHistoryManager ç±»å·¥ä½œæ­£å¸¸ï¼")
           
       except Exception as e:
           print(f"\nâŒ æµ‹è¯•å¤±è´¥: {str(e)}")
           import traceback
           traceback.print_exc()
           
       finally:
           # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
           if os.path.exists(temp_history_file):
               os.unlink(temp_history_file)
           csv_file = temp_history_file.replace('.json', '.csv')
           if os.path.exists(csv_file):
               os.unlink(csv_file)
           print(f"\nğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ")
   ```

   é¢„æœŸæ‰§è¡Œæ•ˆæœï¼š

   ```python
   ğŸš€ å¼€å§‹æµ‹è¯• ChatHistoryManager ç±»...
   
   ğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–ç®¡ç†å™¨
   åŠ è½½å†å²è®°å½•å¤±è´¥: Expecting value: line 1 column 1 (char 0)
      âœ… åˆå§‹åŒ–æˆåŠŸï¼Œå†å²æ–‡ä»¶: C:\Users\admin\AppData\Local\Temp\tmpc1gk_ek6.json
   
   ğŸ’¬ æµ‹è¯•2: æ·»åŠ æ¶ˆæ¯
      âœ… æˆåŠŸæ·»åŠ  4 æ¡æ¶ˆæ¯
   
   ğŸ“– æµ‹è¯•3: è·å–å†å²è®°å½•
      âœ… è·å–å®Œæ•´å†å²: 4 æ¡è®°å½•
      âœ… è·å–ç”¨æˆ·æ¶ˆæ¯: 2 æ¡è®°å½•
      âœ… è·å–æœ€æ–°åŠ©æ‰‹æ¶ˆæ¯: 1 æ¡è®°å½•
   
   ğŸ” æµ‹è¯•4: æœç´¢åŠŸèƒ½
      âœ… æœç´¢ 'Python': æ‰¾åˆ° 4 æ¡ç»“æœ
      âœ… æœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ 'é¡¹ç›®': æ‰¾åˆ° 1 æ¡ç»“æœ
      âœ… æœç´¢ 'JavaScript': æ‰¾åˆ° 0 æ¡ç»“æœ
   
   ğŸ“Š æµ‹è¯•5: å¯¼å‡ºåŠŸèƒ½
      âœ… å¯¼å‡ºCSVå­—ç¬¦ä¸²: 417 å­—ç¬¦
      âœ… ä¿å­˜CSVæ–‡ä»¶: C:\Users\admin\AppData\Local\Temp\tmpc1gk_ek6.csv
   
   ğŸ’¾ æµ‹è¯•6: ä¿å­˜å’ŒåŠ è½½
      âœ… ä¿å­˜å†å²è®°å½•: True
      âœ… åŠ è½½å†å²è®°å½•: True
      âœ… åŠ è½½åè®°å½•æ•°: 4
   
   ğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•
      âœ… æ¸…ç©ºå†å²è®°å½•: True
      âœ… æ¸…ç©ºåè®°å½•æ•°: 0
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
   
   ğŸ’¾ æµ‹è¯•6: ä¿å­˜å’ŒåŠ è½½
      âœ… ä¿å­˜å†å²è®°å½•: True
      âœ… åŠ è½½å†å²è®°å½•: True
      âœ… åŠ è½½åè®°å½•æ•°: 4
   
   ğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•
      âœ… æ¸…ç©ºå†å²è®°å½•: True
      âœ… æ¸…ç©ºåè®°å½•æ•°: 0
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
   ğŸ’¾ æµ‹è¯•6: ä¿å­˜å’ŒåŠ è½½
      âœ… ä¿å­˜å†å²è®°å½•: True
      âœ… åŠ è½½å†å²è®°å½•: True
      âœ… åŠ è½½åè®°å½•æ•°: 4
   
   ğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•
      âœ… æ¸…ç©ºå†å²è®°å½•: True
      âœ… æ¸…ç©ºåè®°å½•æ•°: 0
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… åŠ è½½åè®°å½•æ•°: 4
   
   ğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•
      âœ… æ¸…ç©ºå†å²è®°å½•: True
      âœ… æ¸…ç©ºåè®°å½•æ•°: 0
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… æ¸…ç©ºå†å²è®°å½•: True
      âœ… æ¸…ç©ºåè®°å½•æ•°: 0
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
   
   ğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… ç”Ÿæˆæ¶ˆæ¯ID: d18bc7e7-090b-4238-80ee-f793d66203be
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… IDé•¿åº¦: 36 å­—ç¬¦
   
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶: 0 æ¡è®°å½•
   âš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ
      âœ… å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶: 0 æ¡è®°å½•
      âœ… å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶: 0 æ¡è®°å½•
      âœ… æœç´¢ç©ºå†å²: 0 æ¡ç»“æœ
      âœ… å¯¼å‡ºç©ºå†å²: ''
   
   ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼ChatHistoryManager ç±»å·¥ä½œæ­£å¸¸ï¼
   
   ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ
   ```

### ç¬¬äºŒéƒ¨åˆ†ï¼šè£…é¥°å™¨å·¥å…·é›†ï¼ˆdecorators.pyæ ¸å¿ƒåŠŸèƒ½ï¼‰
**ä»£ç æ–‡ä»¶ï¼š** `study-agentic-rag/03-smart-qa-application/utils/decorators.py`

**æ ¸å¿ƒèŒè´£**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§

<details>
<summary>ç‚¹å‡»å±•å¼€æ ¸å¿ƒä»£ç ï¼ˆerror_handler + log_executionï¼‰</summary>

```python
import functools
import logging
import time
import traceback
from typing import Callable, Any, Optional
import streamlit as st
from config.settings import Settings

logger = logging.getLogger(__name__)

def error_handler(
    func_name: str = None,
    show_in_ui: bool = True,
    log_level: str = "ERROR",
    return_on_error: Any = None,
    error_message: str = None
):
    """é”™è¯¯å¤„ç†è£…é¥°å™¨
    
    æ–¹æ³•ç”¨é€”ï¼šä¸ºå‡½æ•°æä¾›ç»Ÿä¸€çš„å¼‚å¸¸æ•è·å’Œå¤„ç†æœºåˆ¶ï¼Œé˜²æ­¢ç¨‹åºå› å¼‚å¸¸è€Œå´©æºƒï¼Œ
    åŒæ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤ºå’Œæ—¥å¿—è®°å½•åŠŸèƒ½
    
    å‚æ•°è§£é‡Šï¼š
        func_name (str, å¯é€‰): å‡½æ•°æ˜¾ç¤ºåç§°ï¼Œç”¨äºæ—¥å¿—å’ŒUIæ˜¾ç¤ºï¼ŒNoneåˆ™ä½¿ç”¨å®é™…å‡½æ•°å
        show_in_ui (bool, å¯é€‰): æ˜¯å¦åœ¨Streamlitç•Œé¢æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œé»˜è®¤True
        log_level (str, å¯é€‰): æ—¥å¿—çº§åˆ«ï¼Œæ”¯æŒ"ERROR", "WARNING", "INFO", "DEBUG"ï¼Œé»˜è®¤"ERROR"
        return_on_error (Any, å¯é€‰): å‘ç”Ÿé”™è¯¯æ—¶è¿”å›çš„é»˜è®¤å€¼ï¼Œé»˜è®¤None
        error_message (str, å¯é€‰): è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯å‰ç¼€ï¼ŒNoneåˆ™ä½¿ç”¨é»˜è®¤æ¶ˆæ¯
        
    è¿”å›å€¼ï¼š
        Callable: è£…é¥°å™¨å‡½æ•°ï¼Œè¿”å›åŒ…è£…åçš„å‡½æ•°
        
    ä½¿ç”¨ç¤ºä¾‹ï¼š
        # åŸºæœ¬ç”¨æ³• - æ•è·å¼‚å¸¸å¹¶è¿”å›None
        >>> @error_handler
        >>> def divide(a, b):
        >>>     return a / b
        >>> 
        >>> result = divide(10, 2)   # æ­£å¸¸æ‰§è¡Œï¼Œè¿”å›5.0
        >>> result = divide(10, 0)   # æ•è·å¼‚å¸¸ï¼Œè¿”å›None
        
        # é«˜çº§ç”¨æ³• - è‡ªå®šä¹‰é”™è¯¯å¤„ç†
        >>> @error_handler(
        >>>     func_name="å®‰å…¨é™¤æ³•å™¨",
        >>>     return_on_error=-1,
        >>>     error_message="é™¤æ³•è®¡ç®—å¤±è´¥",
        >>>     show_in_ui=True,
        >>>     log_level="WARNING"
        >>> )
        >>> def safe_divide(a, b):
        >>>     return a / b
        >>> 
        >>> result = safe_divide(10, 0)  # è¿”å›-1ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—ï¼ŒUIæ˜¾ç¤ºé”™è¯¯
    """
    def decorator(func: Callable) -> Callable:
        """é”™è¯¯å¤„ç†è£…é¥°å™¨çš„å†…éƒ¨è£…é¥°å™¨å‡½æ•°
        
        æ–¹æ³•ç”¨é€”ï¼šæ¥æ”¶è¢«è£…é¥°çš„å‡½æ•°ï¼Œè¿”å›åŒ…è£…åçš„å‡½æ•°ï¼Œåœ¨åŒ…è£…å‡½æ•°ä¸­æ·»åŠ å¼‚å¸¸æ•è·å’Œå¤„ç†é€»è¾‘

        """
        @functools.wraps(func)
        def wrapper(*args, **kwargs) -> Any:
            """é”™è¯¯å¤„ç†åŒ…è£…å‡½æ•°
            
            æ–¹æ³•ç”¨é€”ï¼šåŒ…è£…åŸå§‹å‡½æ•°ï¼Œåœ¨æ‰§è¡Œæ—¶æ•è·å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†ï¼Œ
            è®°å½•æ—¥å¿—ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œè¿”å›é»˜è®¤å€¼
         
            """
            try:
                return func(*args, **kwargs)
            except Exception as e:
                # è·å–å‡½æ•°åç§°
                actual_func_name = func_name or func.__name__

                # æ„å»ºé”™è¯¯ä¿¡æ¯
                error_msg = error_message or f"å‡½æ•° '{actual_func_name}' æ‰§è¡Œå¤±è´¥"
                full_error_msg = f"{error_msg}: {str(e)}"

                # è®°å½•æ—¥å¿—
                log_func = getattr(logger, log_level.lower(), logger.error)
                log_func(full_error_msg)

                # è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
                logger.debug(f"é”™è¯¯è¯¦æƒ…:\n{traceback.format_exc()}")

                # åœ¨UIä¸­æ˜¾ç¤ºé”™è¯¯ï¼ˆå¦‚æœä½¿ç”¨Streamlitï¼‰
                if show_in_ui and hasattr(st, 'error'):
                    st.error(f"âŒ {full_error_msg}")

                    # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ï¼ˆåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼‰
                    # settings = Settings()
                    # ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    if logger.level <= logging.DEBUG:
                        with st.expander("ğŸ” æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"):
                            st.code(traceback.format_exc())

                # è¿”å›é”™è¯¯æ—¶çš„é»˜è®¤å€¼
                return return_on_error

        return wrapper
    return decorator

def log_execution(
    func_name: str = None,
    log_level: str = "INFO",
    log_args: bool = False,
    log_result: bool = False,
    log_time: bool = True
):
    """æ‰§è¡Œæ—¥å¿—è£…é¥°å™¨
    
    æ–¹æ³•ç”¨é€”ï¼šä¸ºå‡½æ•°æä¾›è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—è®°å½•ï¼ŒåŒ…æ‹¬å¼€å§‹æ—¶é—´ã€æ‰§è¡Œæ—¶é—´ã€å‚æ•°å’Œè¿”å›å€¼ï¼Œ
    å¸®åŠ©å¼€å‘è€…è¿½è¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹å’Œè°ƒè¯•é—®é¢˜
    
    å‚æ•°è§£é‡Šï¼š
        func_name (str, å¯é€‰): å‡½æ•°åç§°ï¼Œç”¨äºæ—¥å¿—è®°å½•ï¼ŒNoneåˆ™ä½¿ç”¨å®é™…å‡½æ•°å
        log_level (str, å¯é€‰): æ—¥å¿—çº§åˆ«ï¼Œæ”¯æŒ"INFO", "DEBUG", "WARNING", "ERROR"ï¼Œé»˜è®¤"INFO"
        log_args (bool, å¯é€‰): æ˜¯å¦è®°å½•å‡½æ•°å‚æ•°ï¼Œé»˜è®¤False
        log_result (bool, å¯é€‰): æ˜¯å¦è®°å½•å‡½æ•°è¿”å›å€¼ï¼Œé»˜è®¤False
        log_time (bool, å¯é€‰): æ˜¯å¦è®°å½•æ‰§è¡Œæ—¶é—´ï¼Œé»˜è®¤True
        
    è¿”å›å€¼ï¼š
        Callable: è£…é¥°å™¨å‡½æ•°ï¼Œè¿”å›åŒ…è£…åçš„å‡½æ•°
        
    ä½¿ç”¨ç¤ºä¾‹ï¼š
        # åŸºæœ¬ç”¨æ³• - è®°å½•æ‰§è¡Œæ—¶é—´å’ŒçŠ¶æ€
        >>> @log_execution
        >>> def calculate_sum(a, b):
        >>>     return a + b
        >>> 
        >>> result = calculate_sum(5, 3)  # è®°å½•ï¼šå¼€å§‹æ‰§è¡Œã€æ‰§è¡Œå®Œæˆã€è€—æ—¶
        
        # é«˜çº§ç”¨æ³• - è®°å½•è¯¦ç»†ä¿¡æ¯
        >>> @log_execution(
        >>>     func_name="æ•°æ®å¤„ç†å‡½æ•°",
        >>>     log_args=True,
        >>>     log_result=True,
        >>>     log_level="DEBUG",
        >>>     log_time=True
        >>> )
        >>> def process_data(items):
        >>>     return [item.upper() for item in items]
        >>> 
        >>> # è®°å½•ï¼šå¼€å§‹æ‰§è¡Œã€å‚æ•°ã€è¿”å›å€¼ã€æ‰§è¡Œæ—¶é—´
        >>> result = process_data(['hello', 'world'])
    """
    def decorator(func: Callable) -> Callable:
        @functools.wraps(func)
        def wrapper(*args, **kwargs) -> Any:
            """æ‰§è¡Œæ—¥å¿—åŒ…è£…å‡½æ•°
            
            æ–¹æ³•ç”¨é€”ï¼šåŒ…è£…åŸå§‹å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå‰åè®°å½•è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼Œ
            åŒ…æ‹¬å¼€å§‹æ‰§è¡Œã€å‚æ•°ã€æ‰§è¡Œæ—¶é—´ã€è¿”å›å€¼ç­‰

            """
            # è·å–å‡½æ•°åç§°
            actual_func_name = func_name or func.__name__

            # è·å–æ—¥å¿—å‡½æ•°
            log_func = getattr(logger, log_level.lower(), logger.info)

            try:
                # è®°å½•å‡½æ•°å¼€å§‹æ‰§è¡Œ
                start_time = time.time()
                log_func(f"å¼€å§‹æ‰§è¡Œå‡½æ•°: {actual_func_name}")

                # è®°å½•å‚æ•°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if log_args:
                    args_str = str(args) if args else ""
                    kwargs_str = str(kwargs) if kwargs else ""
                    log_func(f"å‡½æ•°å‚æ•° - args: {args_str}, kwargs: {kwargs_str}")

                # æ‰§è¡Œå‡½æ•°
                result = func(*args, **kwargs)

                # è®°å½•æ‰§è¡Œæ—¶é—´ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if log_time:
                    execution_time = time.time() - start_time
                    log_func(f"å‡½æ•°æ‰§è¡Œå®Œæˆ: {actual_func_name} (è€—æ—¶: {execution_time:.3f}ç§’)")
                else:
                    log_func(f"å‡½æ•°æ‰§è¡Œå®Œæˆ: {actual_func_name}")

                # è®°å½•è¿”å›å€¼ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if log_result:
                    result_str = str(result) if result is not None else "None"
                    # é™åˆ¶ç»“æœå­—ç¬¦ä¸²é•¿åº¦
                    if len(result_str) > 500:
                        result_str = result_str[:500] + "..."
                    log_func(f"å‡½æ•°è¿”å›å€¼: {result_str}")

                return result

            except Exception as e:
                # è®°å½•å¼‚å¸¸ä¿¡æ¯
                execution_time = time.time() - start_time if log_time else 0
                error_msg = f"å‡½æ•°æ‰§è¡Œå¼‚å¸¸: {actual_func_name}"
                if log_time:
                    error_msg += f" (è€—æ—¶: {execution_time:.3f}ç§’)"
                error_msg += f" - {str(e)}"

                logger.error(error_msg)
                logger.debug(f"è¯¦ç»†é”™è¯¯ä¿¡æ¯:\n{traceback.format_exc()}")

                # é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©ä¸Šå±‚å¤„ç†
                raise

        return wrapper
    return decorator

def performance_monitor(
    func_name: str = None,
    warning_threshold: float = 1.0,
    error_threshold: float = 5.0
):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨
    
    æ–¹æ³•ç”¨é€”ï¼šç›‘æ§å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ï¼Œæ ¹æ®è®¾å®šçš„æ€§èƒ½é˜ˆå€¼è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼Œ
    å¸®åŠ©å¼€å‘è€…åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆå’Œæ…¢æŸ¥è¯¢é—®é¢˜
    
    å‚æ•°è§£é‡Šï¼š
        func_name (str, å¯é€‰): å‡½æ•°åç§°ï¼Œç”¨äºæ—¥å¿—è®°å½•ï¼ŒNoneåˆ™ä½¿ç”¨å®é™…å‡½æ•°å
        warning_threshold (float, å¯é€‰): è­¦å‘Šé˜ˆå€¼ï¼ˆç§’ï¼‰ï¼Œè¶…è¿‡æ­¤æ—¶é—´è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œé»˜è®¤1.0ç§’
        error_threshold (float, å¯é€‰): é”™è¯¯é˜ˆå€¼ï¼ˆç§’ï¼‰ï¼Œè¶…è¿‡æ­¤æ—¶é—´è®°å½•é”™è¯¯æ—¥å¿—ï¼Œé»˜è®¤5.0ç§’
        
    è¿”å›å€¼ï¼š
        Callable: è£…é¥°å™¨å‡½æ•°ï¼Œè¿”å›åŒ…è£…åçš„å‡½æ•°
        
    ä½¿ç”¨ç¤ºä¾‹ï¼š
        # åŸºæœ¬ç”¨æ³• - ä½¿ç”¨é»˜è®¤é˜ˆå€¼ç›‘æ§
        >>> @performance_monitor
        >>> def slow_function():
        >>>     time.sleep(0.5)
        >>>     return "å®Œæˆ"
        >>> 
        >>> result = slow_function()  # è®°å½•ï¼šæ€§èƒ½æ­£å¸¸ (è€—æ—¶: 0.500ç§’)
        
        # é«˜çº§ç”¨æ³• - è‡ªå®šä¹‰æ€§èƒ½é˜ˆå€¼
        >>> @performance_monitor(
        >>>     func_name="æ•°æ®åº“æŸ¥è¯¢",
        >>>     warning_threshold=0.1,    # 100msè­¦å‘Š
        >>>     error_threshold=0.5       # 500msé”™è¯¯
        >>> )
        >>> def query_database(sql):
        >>>     # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        >>>     time.sleep(0.2)
        >>>     return f"æŸ¥è¯¢ç»“æœ: {sql}"
        >>> 
        >>> result = query_database("SELECT * FROM users")
        >>> # è®°å½•ï¼šæ€§èƒ½è­¦å‘Š - å‡½æ•°æ‰§è¡Œè¾ƒæ…¢: æ•°æ®åº“æŸ¥è¯¢ (è€—æ—¶: 0.200ç§’)
    """
    def decorator(func: Callable) -> Callable:
            """æ€§èƒ½ç›‘æ§è£…é¥°å™¨çš„å†…éƒ¨è£…é¥°å™¨å‡½æ•°
            
            æ–¹æ³•ç”¨é€”ï¼šæ¥æ”¶è¢«è£…é¥°çš„å‡½æ•°ï¼Œè¿”å›åŒ…è£…åçš„å‡½æ•°ï¼Œåœ¨åŒ…è£…å‡½æ•°ä¸­
            æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¶é—´è®°å½•åŠŸèƒ½

            """
            @functools.wraps(func)
            def wrapper(*args, **kwargs) -> Any:
                """æ€§èƒ½ç›‘æ§åŒ…è£…å‡½æ•°
                
                æ–¹æ³•ç”¨é€”ï¼šåŒ…è£…åŸå§‹å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå‰åè®°å½•æ€§èƒ½ä¿¡æ¯ï¼Œ
                æ ¹æ®æ‰§è¡Œæ—¶é—´ä¸é˜ˆå€¼çš„æ¯”è¾ƒè®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—
                
                """
                actual_func_name = func_name or func.__name__
                start_time = time.time()

                try:
                    # æ‰§è¡Œå‡½æ•°
                    result = func(*args, **kwargs)

                    # è®¡ç®—æ‰§è¡Œæ—¶é—´
                    execution_time = time.time() - start_time

                    # æ ¹æ®æ‰§è¡Œæ—¶é—´è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—
                    if execution_time >= error_threshold:
                        logger.error(f"æ€§èƒ½å‘Šè­¦ - å‡½æ•°æ‰§è¡Œè¿‡æ…¢: {actual_func_name} (è€—æ—¶: {execution_time:.3f}ç§’)")
                    elif execution_time >= warning_threshold:
                        logger.warning(f"æ€§èƒ½è­¦å‘Š - å‡½æ•°æ‰§è¡Œè¾ƒæ…¢: {actual_func_name} (è€—æ—¶: {execution_time:.3f}ç§’)")
                    else:
                        logger.info(f"æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: {actual_func_name} (è€—æ—¶: {execution_time:.3f}ç§’)")

                    return result

                except Exception as e:
                    execution_time = time.time() - start_time
                    logger.error(f"æ€§èƒ½ç›‘æ§ - å‡½æ•°æ‰§è¡Œå¼‚å¸¸: {actual_func_name} (è€—æ—¶: {execution_time:.3f}ç§’) - {str(e)}")
                    raise

            return wrapper
    return decorator
```

</details>

**ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Ÿ**

1. **ä¸ºä»€ä¹ˆåœ¨UIä¸­æ˜¾ç¤ºé”™è¯¯ï¼Ÿ**
   ```python
   if show_in_ui and hasattr(st, 'error'):
       st.error(f"âŒ {full_error_msg}")
   ```
   - **ç”¨æˆ·ä½“éªŒ**ï¼šé”™è¯¯ç›´æ¥æ˜¾ç¤ºåœ¨ç•Œé¢ï¼Œæ— éœ€çœ‹æ—¥å¿—
   - **å¼€å‘æ¨¡å¼**ï¼šDEBUGæ—¶æ˜¾ç¤ºè¯¦ç»†å †æ ˆï¼ˆ`st.expander`ï¼‰
   - **çµæ´»æ€§**ï¼š`show_in_ui=False`å¯ä»¥å…³é—­UIæç¤º

2. **ä¸ºä»€ä¹ˆç”¨`@functools.wraps`ï¼Ÿ**
   ```python
   @functools.wraps(func)
   def wrapper(*args, **kwargs):
       ...
   ```
   - ä¿ç•™åŸå‡½æ•°çš„å…ƒæ•°æ®ï¼ˆ`__name__`ã€`__doc__`ç­‰ï¼‰
   - å¦åˆ™è£…é¥°åï¼Œ`func.__name__`ä¼šå˜æˆ`"wrapper"`
   - æ–¹ä¾¿è°ƒè¯•å’Œæ—¥å¿—è®°å½•

3. **ä¸ºä»€ä¹ˆæ€§èƒ½ç›‘æ§æœ‰ä¸¤ä¸ªé˜ˆå€¼ï¼Ÿ**
   ```python
   warning_threshold: float = 1.0   # 1ç§’è­¦å‘Š
   error_threshold: float = 5.0     # 5ç§’å‘Šè­¦
   ```
   - **è­¦å‘Š**ï¼šæé†’å¼€å‘è€…å…³æ³¨ï¼Œä½†ä¸å½±å“åŠŸèƒ½
   - **å‘Šè­¦**ï¼šä¸¥é‡æ€§èƒ½é—®é¢˜ï¼Œéœ€è¦ä¼˜åŒ–
   - **åˆ†çº§ç›‘æ§**ï¼šåŒºåˆ†è½»é‡ç¼“æ€¥

4. **ä¸ºä»€ä¹ˆé™åˆ¶è¿”å›å€¼å­—ç¬¦ä¸²é•¿åº¦ï¼Ÿ**
   ```python
   if len(result_str) > 500:
       result_str = result_str[:500] + "..."
   ```
   - è¿”å›å€¼å¯èƒ½å¾ˆå¤§ï¼ˆå¦‚æ–‡æ¡£åˆ—è¡¨ï¼‰
   - æ—¥å¿—æ–‡ä»¶ä¸åº”è¯¥è¢«å¤§é‡æ•°æ®æ’‘çˆ†
   - 500å­—ç¬¦è¶³å¤Ÿè°ƒè¯•

5. è¿›ä¸€æ­¥è§£é‡Šè¯´æ˜ï¼š

> ## ğŸ› ï¸ è£…é¥°å™¨ä½¿ç”¨è¯´æ˜
>
> ### 1. **é”™è¯¯å¤„ç†è£…é¥°å™¨ (`@error_handler`)**
>
> **ç”¨é€”ï¼š** è‡ªåŠ¨æ•è·å‡½æ•°æ‰§è¡Œä¸­çš„å¼‚å¸¸ï¼Œæä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
>
> **åŸºæœ¬ç”¨æ³•ï¼š**
> ```python
> @error_handler
> def divide_numbers(a, b):
>     return a / b
> 
> # ä½¿ç”¨ - å‘ç”Ÿå¼‚å¸¸æ—¶ä¼šè¿”å›None
> result = divide_numbers(10, 0)  # è¿”å›Noneï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸
> ```
>
> **é«˜çº§ç”¨æ³•ï¼š**
> ```python
> @error_handler(
>     func_name="é™¤æ³•è®¡ç®—å™¨",           # è‡ªå®šä¹‰å‡½æ•°åç§°
>     return_on_error=-1,              # å‡ºé”™æ—¶è¿”å›-1
>     show_in_ui=True,                 # åœ¨Streamlitç•Œé¢æ˜¾ç¤ºé”™è¯¯
>     log_level="ERROR",               # æ—¥å¿—çº§åˆ«
>     error_message="è®¡ç®—å¤±è´¥"          # è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
> )
> def divide_numbers(a, b):
>     return a / b
> 
> # ä½¿ç”¨ - å‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›-1
> result = divide_numbers(10, 0)  # è¿”å›-1ï¼Œå¹¶è®°å½•é”™è¯¯æ—¥å¿—
> ```
>
> ---
>
> ### 2. **æ‰§è¡Œæ—¥å¿—è£…é¥°å™¨ (`@log_execution`)**
>
> **ç”¨é€”ï¼š** è¯¦ç»†è®°å½•å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒåŒ…æ‹¬å¼€å§‹ã€ç»“æŸã€å‚æ•°ã€è¿”å›å€¼å’Œæ‰§è¡Œæ—¶é—´
>
> **åŸºæœ¬ç”¨æ³•ï¼š**
> ```python
> @log_execution
> def process_data(data):
>     return [item.upper() for item in data]
> 
> # ä½¿ç”¨ - è®°å½•åŸºæœ¬æ‰§è¡Œä¿¡æ¯
> result = process_data(['hello', 'world'])
> # æ—¥å¿—è¾“å‡ºï¼š
> # å¼€å§‹æ‰§è¡Œå‡½æ•°: process_data
> # å‡½æ•°æ‰§è¡Œå®Œæˆ: process_data (è€—æ—¶: 0.001ç§’)
> ```
>
> **é«˜çº§ç”¨æ³•ï¼š**
> ```python
> @log_execution(
>     func_name="æ•°æ®å¤„ç†å‡½æ•°",         # è‡ªå®šä¹‰å‡½æ•°åç§°
>     log_level="DEBUG",               # æ—¥å¿—çº§åˆ«
>     log_args=True,                   # è®°å½•å‡½æ•°å‚æ•°
>     log_result=True,                 # è®°å½•è¿”å›å€¼
>     log_time=True                    # è®°å½•æ‰§è¡Œæ—¶é—´
> )
> def process_data(items):
>     time.sleep(0.1)
>     return [item.upper() for item in items]
> 
> # ä½¿ç”¨ - è®°å½•è¯¦ç»†ä¿¡æ¯
> result = process_data(['hello', 'world'])
> # æ—¥å¿—è¾“å‡ºï¼š
> # å¼€å§‹æ‰§è¡Œå‡½æ•°: æ•°æ®å¤„ç†å‡½æ•°
> # å‡½æ•°å‚æ•° - args: (['hello', 'world'],), kwargs: 
> # å‡½æ•°æ‰§è¡Œå®Œæˆ: æ•°æ®å¤„ç†å‡½æ•° (è€—æ—¶: 0.100ç§’)
> # å‡½æ•°è¿”å›å€¼: ['HELLO', 'WORLD']
> ```
>
> ---
>
> ### 3. **æ€§èƒ½ç›‘æ§è£…é¥°å™¨ (`@performance_monitor`)**
>
> **ç”¨é€”ï¼š** ç›‘æ§å‡½æ•°æ‰§è¡Œæ—¶é—´ï¼Œæ ¹æ®æ€§èƒ½é˜ˆå€¼è®°å½•ä¸åŒçº§åˆ«çš„è­¦å‘Š
>
> **åŸºæœ¬ç”¨æ³•ï¼š**
> ```python
> @performance_monitor
> def slow_function():
>     time.sleep(0.05)
>     return "å®Œæˆ"
> 
> # ä½¿ç”¨ - ä½¿ç”¨é»˜è®¤é˜ˆå€¼ï¼ˆè­¦å‘Šï¼š1ç§’ï¼Œé”™è¯¯ï¼š5ç§’ï¼‰
> result = slow_function()
> # æ—¥å¿—è¾“å‡ºï¼š
> # æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: slow_function (è€—æ—¶: 0.050ç§’)
> ```
>
> **é«˜çº§ç”¨æ³•ï¼š**
> ```python
> @performance_monitor(
>     func_name="æ•°æ®åº“æŸ¥è¯¢",           # è‡ªå®šä¹‰å‡½æ•°åç§°
>     warning_threshold=0.1,          # è­¦å‘Šé˜ˆå€¼ï¼š100ms
>     error_threshold=0.5              # é”™è¯¯é˜ˆå€¼ï¼š500ms
> )
> def query_database(query):
>     # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
>     time.sleep(0.2)
>     return f"æŸ¥è¯¢ç»“æœ: {query}"
> 
> # ä½¿ç”¨ - æ ¹æ®è‡ªå®šä¹‰é˜ˆå€¼ç›‘æ§
> result = query_database("SELECT * FROM users")
> # æ—¥å¿—è¾“å‡ºï¼š
> # æ€§èƒ½è­¦å‘Š - å‡½æ•°æ‰§è¡Œè¾ƒæ…¢: æ•°æ®åº“æŸ¥è¯¢ (è€—æ—¶: 0.200ç§’)
> ```
>
> ---
>
> ### 4. **è£…é¥°å™¨ç»„åˆä½¿ç”¨**
>
> **å¤šç§è£…é¥°å™¨å¯ä»¥å åŠ ä½¿ç”¨ï¼Œé¡ºåºå¾ˆé‡è¦ï¼š**
>
> ```python
> @error_handler(func_name="APIè°ƒç”¨", return_on_error="è¯·æ±‚å¤±è´¥")
> @log_execution(log_args=True, log_result=True)
> @performance_monitor(warning_threshold=0.5, error_threshold=2.0)
> def call_api(endpoint, params):
>     """è°ƒç”¨å¤–éƒ¨API"""
>     time.sleep(0.1)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
>     if "error" in endpoint:
>         raise ValueError("APIè¿”å›é”™è¯¯")
>     return f"æˆåŠŸè°ƒç”¨: {endpoint}"
> 
> # ä½¿ç”¨
> result = call_api("/users", {"id": 1})
> # æ—¥å¿—è¾“å‡ºï¼š
> # å¼€å§‹æ‰§è¡Œå‡½æ•°: APIè°ƒç”¨
> # å‡½æ•°å‚æ•° - args: ('/users', {'id': 1}), kwargs: 
> # æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: APIè°ƒç”¨ (è€—æ—¶: 0.100ç§’)
> # å‡½æ•°æ‰§è¡Œå®Œæˆ: APIè°ƒç”¨ (è€—æ—¶: 0.100ç§’)
> # å‡½æ•°è¿”å›å€¼: æˆåŠŸè°ƒç”¨: /users
> ```
>
> ### 5. **é…ç½®å»ºè®®**
>
> **åœ¨é¡¹ç›®çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š**
> ```python
> # config/settings.py
> class Settings:
>     LOG_LEVEL = "DEBUG"  # å¼€å‘ç¯å¢ƒ
>     # LOG_LEVEL = "INFO"  # ç”Ÿäº§ç¯å¢ƒ
> ```
>
> **åœ¨Streamlitåº”ç”¨ä¸­ä½¿ç”¨é”™è¯¯æ˜¾ç¤ºï¼š**
> ```python
> import streamlit as st
> from utils.decorators import error_handler
> 
> @error_handler(show_in_ui=True)
> def risky_operation():
>     # å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä¼šåœ¨Streamlitç•Œé¢æ˜¾ç¤º
>     pass
> ```
>
> è¿™äº›è£…é¥°å™¨å¯ä»¥å¸®åŠ©ä½ ï¼š
> - ğŸ”’ **æé«˜ä»£ç å¥å£®æ€§** - è‡ªåŠ¨å¤„ç†å¼‚å¸¸
> - ğŸ“Š **å¢å¼ºè°ƒè¯•èƒ½åŠ›** - è¯¦ç»†è®°å½•æ‰§è¡Œè¿‡ç¨‹
> - âš¡ **ç›‘æ§æ€§èƒ½** - åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
> - ğŸ¯ **ç»Ÿä¸€é”™è¯¯å¤„ç†** - æä¾›ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ

6. æµ‹è¯•ä»£ç 

```python
if __name__ == "__main__":
    """è£…é¥°å™¨æµ‹è¯•ä»£ç 
    
    æµ‹è¯•å†…å®¹ï¼š
        1. @error_handler - å¼‚å¸¸å¤„ç†è£…é¥°å™¨
        2. @log_execution - æ‰§è¡Œæ—¥å¿—è£…é¥°å™¨  
        3. @performance_monitor - æ€§èƒ½ç›‘æ§è£…é¥°å™¨
        4. ç»„åˆè£…é¥°å™¨ä½¿ç”¨
        5. è£…é¥°å™¨å‚æ•°åŒ–ä½¿ç”¨
    
    æµ‹è¯•è¾“å‡ºï¼š
        - æ§åˆ¶å°æ—¥å¿—è¾“å‡º
        - å¼‚å¸¸å¤„ç†æ¼”ç¤º
        - æ€§èƒ½ç›‘æ§ç»“æœ
    """
    
    import time
    # é…ç½®æ—¥å¿—å¤„ç†å™¨ä»¥åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ—¥å¿—
    console_handler = logging.StreamHandler() # åˆ›å»ºä¸€ä¸ª æ§åˆ¶å°æ—¥å¿—å¤„ç†å™¨ï¼Œå°†æ—¥å¿—ä¿¡æ¯è¾“å‡ºåˆ° ç»ˆç«¯/æ§åˆ¶å°
    console_handler.setLevel(logging.DEBUG) # è®¾ç½®å¤„ç†å™¨çš„ æ—¥å¿—çº§åˆ«ä¸ºDEBUGã€‚å‘Šè¯‰å¤„ç†å™¨"æ‰€æœ‰çº§åˆ«ä¸ºDEBUGåŠä»¥ä¸Šçš„æ—¥å¿—éƒ½è¦å¤„ç†"ï¼Œçº§åˆ«é¡ºåº ï¼šDEBUG < INFO < WARNING < ERROR < CRITICAL
    formatter = logging.Formatter('%(levelname)s - %(message)s') # åˆ›å»º æ—¥å¿—æ ¼å¼å™¨ã€‚è¾“å‡ºç¤ºä¾‹ ï¼š DEBUG - å¼€å§‹æ‰§è¡Œå‡½æ•°: æ•°æ®å¤„ç†å‡½æ•°
    console_handler.setFormatter(formatter) # å‘Šè¯‰å¤„ç†å™¨"æŒ‰ç…§æˆ‘å®šä¹‰çš„æ ¼å¼æ¥æ˜¾ç¤ºæ—¥å¿—"
    logger.addHandler(console_handler) # è®©loggerçŸ¥é“"æˆ‘æœ‰ä¸€ä¸ªæ§åˆ¶å°å¤„ç†å™¨ï¼Œå¯ä»¥æŠŠæ—¥å¿—è¾“å‡ºåˆ°å±å¹•"
    logger.setLevel(logging.DEBUG) # è®¾ç½®loggerçš„ å…¨å±€æ—¥å¿—çº§åˆ«ä¸ºDEBUG
    
    # æµ‹è¯• @error_handler è£…é¥°å™¨
    print("=== æµ‹è¯• @error_handler è£…é¥°å™¨ ===")
    
    @error_handler(func_name="é™¤æ³•è®¡ç®—å™¨:divide_numbers", return_on_error=-1)
    def divide_numbers(a, b):
        """é™¤æ³•å‡½æ•° - æµ‹è¯•å¼‚å¸¸å¤„ç†"""
        return a / b
    
    # æ­£å¸¸è°ƒç”¨
    result = divide_numbers(10, 2)
    print(f"10 Ã· 2 = {result}")
    
    # å¼‚å¸¸è°ƒç”¨ï¼ˆä¼šè¢«æ•è·å¹¶è®°å½•ï¼‰
    result = divide_numbers(10, 0)  # é™¤é›¶å¼‚å¸¸è¢«æ•è·
    print(f"10 Ã· 0 = {result}")
    
    print()
    
    # æµ‹è¯• @log_execution è£…é¥°å™¨
    print("=== æµ‹è¯• @log_execution è£…é¥°å™¨ ===")
    
    @log_execution(
        func_name="æ•°æ®å¤„ç†å‡½æ•°",
        log_args=True,
        log_result=True,
        log_level="DEBUG",
        log_time=True
    )
    def process_data(items):
        """æ•°æ®å¤„ç†å‡½æ•° - æµ‹è¯•æ‰§è¡Œæ—¥å¿—"""
        return [item.upper() for item in items]
    
    result = process_data(['hello', 'world', 'python'])
    print(f"å¤„ç†ç»“æœ: {result}")
    
    print()
    
    # æµ‹è¯• @performance_monitor è£…é¥°å™¨
    print("=== æµ‹è¯• @performance_monitor è£…é¥°å™¨ ===")
    
    @performance_monitor(
        func_name="æ…¢é€Ÿå‡½æ•°",
        warning_threshold=0.1,  # 100ms è­¦å‘Š
        error_threshold=0.3     # 300ms é”™è¯¯
    )
    def slow_function(delay):
        """æ…¢é€Ÿå‡½æ•° - æµ‹è¯•æ€§èƒ½ç›‘æ§"""
        time.sleep(delay)
        return f"å»¶è¿Ÿäº† {delay} ç§’"
    
    # æ­£å¸¸æ€§èƒ½
    result = slow_function(0.05)  # 50ms - æ­£å¸¸
    print(f"ç»“æœ: {result}")
    
    # è­¦å‘Šæ€§èƒ½
    result = slow_function(0.15)  # 150ms - è­¦å‘Š
    print(f"ç»“æœ: {result}")
    
    # é”™è¯¯æ€§èƒ½
    result = slow_function(0.35)  # 350ms - é”™è¯¯
    print(f"ç»“æœ: {result}")
    
    print()
    
    # æµ‹è¯•ç»„åˆè£…é¥°å™¨
    print("=== æµ‹è¯•ç»„åˆè£…é¥°å™¨ ===")
    
    @error_handler()
    @log_execution(
        func_name="ç»„åˆå‡½æ•°",
        log_args=True,
        log_result=True
    )
    @performance_monitor(
        func_name="ç»„åˆå‡½æ•°",
        warning_threshold=0.1,
        error_threshold=0.5
    )
    def combined_function(x, y):
        """ç»„åˆè£…é¥°å™¨å‡½æ•° - åŒæ—¶å…·æœ‰å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§"""
        time.sleep(0.05)  # 50ms å»¶è¿Ÿ
        return x * y + 100
    
    result = combined_function(5, 8)
    print(f"ç»„åˆå‡½æ•°ç»“æœ: {result}")
    
    print()
    
    # æµ‹è¯•è£…é¥°å™¨ä¸å¸¦å‚æ•°
    print("=== æµ‹è¯•è£…é¥°å™¨ä¸å¸¦å‚æ•° ===")
    
    @error_handler()
    def simple_error_func():
        """ç®€å•é”™è¯¯å‡½æ•°"""
        raise ValueError("æµ‹è¯•å¼‚å¸¸")
    
    @log_execution()
    def simple_log_func(name):
        """ç®€å•æ—¥å¿—å‡½æ•°"""
        return f"Hello, {name}!"
    
    @performance_monitor()
    def simple_perf_func():
        """ç®€å•æ€§èƒ½å‡½æ•°"""
        time.sleep(0.02)
        return "å¿«é€Ÿå®Œæˆ"
    
    # æµ‹è¯•ç®€å•é”™è¯¯å¤„ç†
    try:
        simple_error_func()
    except Exception as e:
        print(f"æ•è·åˆ°å¼‚å¸¸: {e}")
    
    # æµ‹è¯•ç®€å•æ—¥å¿—
    result = simple_log_func("Python")
    print(f"ç®€å•æ—¥å¿—ç»“æœ: {result}")
    
    # æµ‹è¯•ç®€å•æ€§èƒ½
    result = simple_perf_func()
    print(f"ç®€å•æ€§èƒ½ç»“æœ: {result}")
    
    print("\n=== æ‰€æœ‰æµ‹è¯•å®Œæˆ ===")
```

6. è¿è¡Œæµ‹è¯•

```bash
uv run pyhton utils/decorators.py
```

é¢„æœŸæµ‹è¯•æ•ˆæœï¼š

```bash
=== æµ‹è¯• @error_handler è£…é¥°å™¨ ===
10 Ã· 2 = 5.0
ERROR - å‡½æ•° 'é™¤æ³•è®¡ç®—å™¨:divide_numbers' æ‰§è¡Œå¤±è´¥: division by zero
DEBUG - é”™è¯¯è¯¦æƒ…:
Traceback (most recent call last):
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 94, in wrapper  
    return func(*args, **kwargs)
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 395, in divide_numbers
    return a / b
           ~~^~~
ZeroDivisionError: division by zero

10 Ã· 0 = -1

=== æµ‹è¯• @log_execution è£…é¥°å™¨ ===
DEBUG - å¼€å§‹æ‰§è¡Œå‡½æ•°: æ•°æ®å¤„ç†å‡½æ•°
DEBUG - å‡½æ•°å‚æ•° - args: (['hello', 'world', 'python'],), kwargs:
DEBUG - å‡½æ•°æ‰§è¡Œå®Œæˆ: æ•°æ®å¤„ç†å‡½æ•° (è€—æ—¶: 0.000ç§’)
DEBUG - å‡½æ•°è¿”å›å€¼: ['HELLO', 'WORLD', 'PYTHON']
å¤„ç†ç»“æœ: ['HELLO', 'WORLD', 'PYTHON']

=== æµ‹è¯• @performance_monitor è£…é¥°å™¨ ===
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.051ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.05 ç§’
WARNING - æ€§èƒ½è­¦å‘Š - å‡½æ•°æ‰§è¡Œè¾ƒæ…¢: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.151ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.15 ç§’
ERROR - æ€§èƒ½å‘Šè­¦ - å‡½æ•°æ‰§è¡Œè¿‡æ…¢: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.351ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.35 ç§’

=== æµ‹è¯•ç»„åˆè£…é¥°å™¨ ===
INFO - å¼€å§‹æ‰§è¡Œå‡½æ•°: ç»„åˆå‡½æ•°
INFO - å‡½æ•°å‚æ•° - args: (5, 8), kwargs:
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: ç»„åˆå‡½æ•° (è€—æ—¶: 0.050ç§’)
INFO - å‡½æ•°æ‰§è¡Œå®Œæˆ: ç»„åˆå‡½æ•° (è€—æ—¶: 0.051ç§’)
INFO - å‡½æ•°è¿”å›å€¼: 140
ç»„åˆå‡½æ•°ç»“æœ: 140

=== æµ‹è¯•è£…é¥°å™¨ä¸å¸¦å‚æ•° ===
ERROR - å‡½æ•° 'simple_error_func' æ‰§è¡Œå¤±è´¥: æµ‹è¯•å¼‚å¸¸
DEBUG - é”™è¯¯è¯¦æƒ…:
Traceback (most recent call last):
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 94, in wrapper  
    return func(*args, **kwargs)
rror_func
ValueError: æµ‹è¯•å¼‚å¸¸

INFO - å¼€å§‹æ‰§è¡Œå‡½æ•°: simple_log_func
INFO - å‡½æ•°æ‰§è¡Œå®Œæˆ: simple_log_func (è€—æ—¶: 0.000ç§’)
ç®€å•æ—¥å¿—ç»“æœ: Hello, Python!
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: simple_perf_func (è€—æ—¶: 0.021ç§’)
ç®€å•æ€§èƒ½ç»“æœ: å¿«é€Ÿå®Œæˆ

=== æ‰€æœ‰æµ‹è¯•å®Œæˆ ===
(agentic-rag-smart-qa) (TraeAI-5) E:\LLM-Code\agentic-rag-case\03-smart-qa-application [0:0] $
(agentic-rag-smart-qa) (TraeAI-5) E:\LLM-Code\agentic-rag-case\03-smart-qa-application [0:0] $ python utils/decorators.py
=== æµ‹è¯• @error_handler è£…é¥°å™¨ ===
10 Ã· 2 = 5.0
ERROR - å‡½æ•° 'é™¤æ³•è®¡ç®—å™¨:divide_numbers' æ‰§è¡Œå¤±è´¥: division by zero
DEBUG - é”™è¯¯è¯¦æƒ…:
Traceback (most recent call last):
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 94, in wrapper  
    return func(*args, **kwargs)
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 395, in divide_numbers
    return a / b
           ~~^~~
ZeroDivisionError: division by zero

10 Ã· 0 = -1

=== æµ‹è¯• @log_execution è£…é¥°å™¨ ===
DEBUG - å¼€å§‹æ‰§è¡Œå‡½æ•°: æ•°æ®å¤„ç†å‡½æ•°
DEBUG - å‡½æ•°å‚æ•° - args: (['hello', 'world', 'python'],), kwargs:
DEBUG - å‡½æ•°æ‰§è¡Œå®Œæˆ: æ•°æ®å¤„ç†å‡½æ•° (è€—æ—¶: 0.000ç§’)
DEBUG - å‡½æ•°è¿”å›å€¼: ['HELLO', 'WORLD', 'PYTHON']
å¤„ç†ç»“æœ: ['HELLO', 'WORLD', 'PYTHON']

=== æµ‹è¯• @performance_monitor è£…é¥°å™¨ ===
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.050ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.05 ç§’
WARNING - æ€§èƒ½è­¦å‘Š - å‡½æ•°æ‰§è¡Œè¾ƒæ…¢: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.150ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.15 ç§’
ERROR - æ€§èƒ½å‘Šè­¦ - å‡½æ•°æ‰§è¡Œè¿‡æ…¢: æ…¢é€Ÿå‡½æ•° (è€—æ—¶: 0.351ç§’)
ç»“æœ: å»¶è¿Ÿäº† 0.35 ç§’

=== æµ‹è¯•ç»„åˆè£…é¥°å™¨ ===
INFO - å¼€å§‹æ‰§è¡Œå‡½æ•°: ç»„åˆå‡½æ•°
INFO - å‡½æ•°å‚æ•° - args: (5, 8), kwargs:
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: ç»„åˆå‡½æ•° (è€—æ—¶: 0.051ç§’)
INFO - å‡½æ•°æ‰§è¡Œå®Œæˆ: ç»„åˆå‡½æ•° (è€—æ—¶: 0.052ç§’)
INFO - å‡½æ•°è¿”å›å€¼: 140
ç»„åˆå‡½æ•°ç»“æœ: 140

=== æµ‹è¯•è£…é¥°å™¨ä¸å¸¦å‚æ•° ===
ERROR - å‡½æ•° 'simple_error_func' æ‰§è¡Œå¤±è´¥: æµ‹è¯•å¼‚å¸¸
DEBUG - é”™è¯¯è¯¦æƒ…:
Traceback (most recent call last):
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 94, in wrapper  
    return func(*args, **kwargs)
  File "E:\LLM-Code\agentic-rag-case\03-smart-qa-application\utils\decorators.py", line 483, in simple_error_func
    raise ValueError("æµ‹è¯•å¼‚å¸¸")
ValueError: æµ‹è¯•å¼‚å¸¸

INFO - å¼€å§‹æ‰§è¡Œå‡½æ•°: simple_log_func
INFO - å‡½æ•°æ‰§è¡Œå®Œæˆ: simple_log_func (è€—æ—¶: 0.000ç§’)
ç®€å•æ—¥å¿—ç»“æœ: Hello, Python!
INFO - æ€§èƒ½æ­£å¸¸ - å‡½æ•°æ‰§è¡Œå®Œæˆ: simple_perf_func (è€—æ—¶: 0.021ç§’)
ç®€å•æ€§èƒ½ç»“æœ: å¿«é€Ÿå®Œæˆ

=== æ‰€æœ‰æµ‹è¯•å®Œæˆ ===
```

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šUIç»„ä»¶å°è£…ï¼ˆui_components.pyæ ¸å¿ƒåŠŸèƒ½ï¼‰

**ä»£ç æ–‡ä»¶ï¼š** `study-agentic-rag/03-smart-qa-application/utils/ui_components.py`

**æ ¸å¿ƒèŒè´£**ï¼šå°è£…Streamlitç»„ä»¶ï¼Œç»Ÿä¸€ç•Œé¢é£æ ¼

<details>
<summary>ç‚¹å‡»å±•å¼€æ ¸å¿ƒä»£ç ï¼ˆæ¨¡å‹é€‰æ‹©å™¨ + RAGè®¾ç½®ï¼‰</summary>

```python
import streamlit as st
from typing import List, Dict, Optional, Any
from config.settings import Settings

class UIComponents:
    """UIç»„ä»¶ç±» - è´Ÿè´£æ¸²æŸ“å„ç§Streamlitç•Œé¢å…ƒç´ """

    def __init__(self):
        self.settings = Settings()

    
    def render_model_selector(self, current_model: str, key_prefix: str = "") -> str:
        """æ¸²æŸ“æ¨¡å‹é€‰æ‹©å™¨"""
        """
        - ä½œç”¨ ï¼šè®©ç”¨æˆ·é€‰æ‹©AIæ¨¡å‹
        - ç•Œé¢å…ƒç´  ï¼šä¸‹æ‹‰é€‰æ‹©æ¡† + åˆ·æ–°æŒ‰é’®
        - è¿”å› ï¼šç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹åç§°
        """
        col1, col2 = st.columns([2, 1])

        with col1:
            selected_model = st.selectbox(
                "ğŸ¤– é€‰æ‹©æ¨¡å‹",
                options=self.settings.AVAILABLE_MODELS,
                index=self.settings.AVAILABLE_MODELS.index(current_model)
                if current_model in self.settings.AVAILABLE_MODELS else 0,
                help="é€‰æ‹©è¦ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹",
                key=f"{key_prefix}model_selector"
            )

        with col2:
            if st.button("ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨", key=f"{key_prefix}refresh_models"):
                st.rerun()

        return selected_model

    def render_temperature_slider(self, current_temp: float, key_prefix: str = "") -> float:
        """æ¸²æŸ“æ¸©åº¦ç³»æ•°æ»‘å—"""
        """
        - ä½œç”¨ ï¼šæ§åˆ¶AIå›ç­”çš„éšæœºæ€§ï¼ˆ0.0-1.0ï¼‰
        - ç•Œé¢å…ƒç´  ï¼šæ»‘å— + æ™ºèƒ½æç¤º
        - è¿”å› ï¼šæ¸©åº¦å€¼
        """
        temperature = st.slider(
            "ğŸŒ¡ï¸ æ¸©åº¦ç³»æ•° (Temperature)",
            min_value=0.0,
            max_value=1.0,
            value=current_temp,
            step=0.1,
            help="æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜ï¼Œå›ç­”è¶Šéšæœºï¼›å€¼è¶Šä½ï¼Œå›ç­”è¶Šç¡®å®šã€‚",
            key=f"{key_prefix}temperature_slider"
        )

        # æ˜¾ç¤ºæ¸©åº¦è§£é‡Š
        temp_explanation = self._get_temperature_explanation(temperature)
        st.caption(f"ğŸ’¡ {temp_explanation}")

        return temperature

    def render_rag_settings(self, current_top_k: int, current_search_type: str, key_prefix: str = "") -> tuple:
        """æ¸²æŸ“RAGè®¾ç½®"""
        """
        - ä½œç”¨ ï¼šé…ç½®æ£€ç´¢å¢å¼ºç”Ÿæˆå‚æ•°
        - ç•Œé¢å…ƒç´  ï¼šä¸¤ä¸ªæ»‘å—/é€‰æ‹©å™¨
        - è¿”å› ï¼štop_kå€¼å’Œæœç´¢ç±»å‹
        """
        st.subheader("ğŸ” RAGè®¾ç½®")

        col1, col2 = st.columns(2)

        with col1:
            top_k = st.slider(
                "æ£€ç´¢æ•°é‡ (Top-K)",
                min_value=1,
                max_value=10,
                value=current_top_k,
                step=1,
                help="ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢çš„ç›¸å…³æ–‡æ¡£æ•°é‡",
                key=f"{key_prefix}top_k_slider"
            )

        with col2:
            search_type = st.selectbox(
                "æœç´¢ç±»å‹",
                options=["similarity", "mmr"],
                index=0 if current_search_type == "similarity" else 1,
                help="similarity: ç›¸ä¼¼åº¦æœç´¢; mmr: æœ€å¤§è¾¹é™…ç›¸å…³æ€§æœç´¢",
                key=f"{key_prefix}search_type_select"
            )

        # æ˜¾ç¤ºæœç´¢ç±»å‹è§£é‡Š
        search_explanation = self._get_search_type_explanation(search_type)
        st.caption(f"ğŸ’¡ {search_explanation}")

        return top_k, search_type

    def render_vector_store_status(self, is_ready: bool, stats: Optional[Dict] = None):
        """æ¸²æŸ“å‘é‡å­˜å‚¨çŠ¶æ€"""
        """
        - ä½œç”¨ ï¼šæ˜¾ç¤ºçŸ¥è¯†åº“çŠ¶æ€
        - ç•Œé¢å…ƒç´  ï¼šçŠ¶æ€æŒ‡ç¤ºå™¨ + ç»Ÿè®¡ä¿¡æ¯
        """
        if is_ready:
            st.success("âœ… å‘é‡å­˜å‚¨å·²å‡†å¤‡å°±ç»ª")

            if stats:
                with st.expander("ğŸ“Š å‘é‡å­˜å‚¨ç»Ÿè®¡"):
                    col1, col2, col3 = st.columns(3)

                    with col1:
                        st.metric("æ–‡æ¡£æ•°é‡", stats.get('documents_count', 0))

                    with col2:
                        st.metric("å‘é‡æ€»æ•°", stats.get('total_vectors', 0))

                    with col3:
                        st.metric("å‘é‡ç»´åº¦", stats.get('dimension', 0))

                    if stats.get('index_path'):
                        st.caption(f"ğŸ“ ç´¢å¼•è·¯å¾„: {stats['index_path']}")

        else:
            st.warning("âš ï¸ å‘é‡å­˜å‚¨æœªå‡†å¤‡")

    def _get_temperature_explanation(self, temperature: float) -> str:
        """è·å–æ¸©åº¦ç³»æ•°è§£é‡Š"""
        if temperature < 0.3:
            return "ä½æ¸©åº¦ï¼šå›ç­”æ›´ç¡®å®šã€ä¿å®ˆ"
        elif temperature < 0.7:
            return "ä¸­ç­‰æ¸©åº¦ï¼šå¹³è¡¡ç¡®å®šæ€§å’Œåˆ›é€ æ€§"
        else:
            return "é«˜æ¸©åº¦ï¼šå›ç­”æ›´éšæœºã€æœ‰åˆ›é€ æ€§"

    def _get_search_type_explanation(self, search_type: str) -> str:
        """è·å–æœç´¢ç±»å‹è§£é‡Š"""
        if search_type == "similarity":
            return "ç›¸ä¼¼åº¦æœç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£"
        else:
            return "MMRæœç´¢ï¼šåœ¨ç›¸å…³æ€§å’Œå¤šæ ·æ€§ä¹‹é—´å–å¾—å¹³è¡¡"
```

</details>

**æ•ˆæœç¤ºæ„å›¾ï¼š**

![image-20251111172250816](https://fwytech-ai-images.oss-cn-beijing.aliyuncs.com/my/lab-images/image-20251111172250816.png)

**ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Ÿ**

1. **ä¸ºä»€ä¹ˆå°è£…UIç»„ä»¶ï¼Ÿ**
   
   ```python
   # app.pyä¸­åŸæœ¬éœ€è¦å†™20è¡Œä»£ç 
   top_k, search_type = ui.render_rag_settings(
       current_top_k=st.session_state.top_k,
       current_search_type=st.session_state.search_type
   )
   ```
   - **ç®€åŒ–app.py**ï¼šä»20è¡Œä»£ç å‡å°‘åˆ°3è¡Œ
   - **ç»Ÿä¸€é£æ ¼**ï¼šæ‰€æœ‰ç•Œé¢ä½¿ç”¨ç›¸åŒçš„ç»„ä»¶
- **æ˜“ç»´æŠ¤**ï¼šä¿®æ”¹æ ·å¼åªéœ€æ”¹ä¸€ä¸ªåœ°æ–¹
  
2. **ä¸ºä»€ä¹ˆç”¨`key_prefix`å‚æ•°ï¼Ÿ**
   ```python
   key=f"{key_prefix}model_selector"
   ```
   - Streamlitè¦æ±‚æ¯ä¸ªç»„ä»¶æœ‰å”¯ä¸€çš„key
   - å¤šä¸ªåœ°æ–¹ä½¿ç”¨åŒä¸€ç»„ä»¶æ—¶ï¼Œæ·»åŠ å‰ç¼€é¿å…å†²çª
   - ç¤ºä¾‹ï¼š
     ```python
     ui.render_model_selector(model, key_prefix="sidebar_")
     ui.render_model_selector(model, key_prefix="main_")
     ```

3. **ä¸ºä»€ä¹ˆæ˜¾ç¤ºå‚æ•°è§£é‡Šï¼Ÿ**
   ```python
   temp_explanation = self._get_temperature_explanation(temperature)
   st.caption(f"ğŸ’¡ {temp_explanation}")
   ```
   - **ç”¨æˆ·æ•™è‚²**ï¼šæ–°æ‰‹ä¸æ‡‚ä»€ä¹ˆæ˜¯temperature
   - **å®æ—¶åé¦ˆ**ï¼šæ»‘å—å˜åŒ–æ—¶ï¼Œè§£é‡Šè·Ÿç€å˜
   - **æå‡ä½“éªŒ**ï¼šè®©ç”¨æˆ·ç†è§£å‚æ•°å«ä¹‰

## å››ã€å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šä½¿ç”¨èŠå¤©å†å²ç®¡ç†å™¨

```python
from utils.chat_history import ChatHistoryManager

# åˆ›å»ºç®¡ç†å™¨
chat_mgr = ChatHistoryManager()

# æ·»åŠ æ¶ˆæ¯
chat_mgr.add_message("user", "ä½ å¥½")
chat_mgr.add_message("assistant", "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ")

# è·å–æœ€è¿‘10æ¡è®°å½•
recent_history = chat_mgr.get_history(limit=10)

# æœç´¢å…³é”®è¯
results = chat_mgr.search_history("å¤©æ°”")

# å¯¼å‡ºCSV
csv_content = chat_mgr.export_to_csv()
st.download_button("ä¸‹è½½CSV", csv_content, "chat.csv")

# æŸ¥çœ‹ç»Ÿè®¡
stats = chat_mgr.get_statistics()
print(f"æ€»æ¶ˆæ¯æ•°: {stats['total_messages']}")
print(f"å¹³å‡æ¶ˆæ¯é•¿åº¦: {stats['average_message_length']}")
```

### ç¤ºä¾‹2ï¼šä½¿ç”¨è£…é¥°å™¨

```python
from utils.decorators import error_handler, log_execution, performance_monitor

# é”™è¯¯å¤„ç†è£…é¥°å™¨
@error_handler(show_in_ui=True, return_on_error="é»˜è®¤å€¼")
def load_file(file_path: str) -> str:
    with open(file_path, 'r') as f:
        return f.read()

# æ‰§è¡Œæ—¥å¿—è£…é¥°å™¨
@log_execution(log_time=True, log_args=True)
def process_document(doc: str) -> List[str]:
    return doc.split("\n\n")

# æ€§èƒ½ç›‘æ§è£…é¥°å™¨
@performance_monitor(warning_threshold=0.5, error_threshold=2.0)
def expensive_operation():
    # å¦‚æœæ‰§è¡Œè¶…è¿‡2ç§’ï¼Œä¼šè®°å½•ERRORæ—¥å¿—
    time.sleep(3)

# ç»„åˆä½¿ç”¨
@error_handler(show_in_ui=True)
@log_execution(log_time=True)
@performance_monitor(warning_threshold=1.0)
def complex_task(data):
    # åŒæ—¶æœ‰é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€æ€§èƒ½ç›‘æ§
    return process(data)
```

### ç¤ºä¾‹3ï¼šä½¿ç”¨UIç»„ä»¶

```python
import streamlit as st
from utils.ui_components import UIComponents

# åˆ›å»ºUIç»„ä»¶å®ä¾‹
ui = UIComponents()

# æ¸²æŸ“ç•Œé¢
st.title("æ™ºèƒ½é—®ç­”ç³»ç»Ÿ")

# 1. æ¨¡å‹é€‰æ‹©
selected_model = ui.render_model_selector("gpt-3.5-turbo")

# 2. æ¸©åº¦è®¾ç½®  
temperature = ui.render_temperature_slider(0.7)

# 3. RAGé…ç½®
top_k, search_type = ui.render_rag_settings(5, "similarity")

# 4. æ˜¾ç¤ºçŠ¶æ€
ui.render_vector_store_status(True, {
    'documents_count': 100,
    'total_vectors': 1000,
    'dimension': 768
})
```

## äº”ã€è£…é¥°å™¨é«˜çº§ç”¨æ³•

**ç»„åˆå¤šä¸ªè£…é¥°å™¨**ï¼š

```python
# è‡ªåº•å‘ä¸Šæ‰§è¡Œï¼ˆä»ä¸‹å¾€ä¸Šï¼‰
@error_handler(show_in_ui=True)       # 3. æœ€å¤–å±‚ï¼šæ•è·å¼‚å¸¸
@log_execution(log_time=True)         # 2. ä¸­é—´å±‚ï¼šè®°å½•æ—¥å¿—
@performance_monitor(warning_threshold=1.0)  # 1. æœ€å†…å±‚ï¼šæ€§èƒ½ç›‘æ§
def my_function():
    # æ‰§è¡Œé¡ºåºï¼š
    # 1. performance_monitorå¼€å§‹è®¡æ—¶
    # 2. log_executionè®°å½•"å¼€å§‹æ‰§è¡Œ"
    # 3. å¦‚æœæœ‰å¼‚å¸¸ï¼Œerror_handleræ•è·å¹¶æ˜¾ç¤ºåœ¨UI
    pass
```

**è‡ªå®šä¹‰è£…é¥°å™¨**ï¼š

```python
def require_login(func):
    """è¦æ±‚ç”¨æˆ·ç™»å½•çš„è£…é¥°å™¨"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        if not st.session_state.get("logged_in", False):
            st.error("è¯·å…ˆç™»å½•")
            return None
        return func(*args, **kwargs)
    return wrapper

@require_login
def admin_function():
    # åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è°ƒç”¨
    pass
```

## å…­ã€å®Œæ•´ä»£ç æ€»ç»“

ä¸‰ä¸ªè¾…åŠ©å·¥å…·ç±»ï¼ˆ1097è¡Œï¼‰æä¾›äº†ï¼š

**ChatHistoryManagerï¼ˆ379è¡Œï¼‰**ï¼š
- CRUDæ“ä½œï¼ˆæ·»åŠ ã€æŸ¥è¯¢ã€åˆ é™¤ã€æ¸…ç©ºï¼‰
- å¯¼å‡ºåŠŸèƒ½ï¼ˆCSVã€JSONï¼‰
- æœç´¢å’Œè¿‡æ»¤
- ç»Ÿè®¡åˆ†æ
- å¤‡ä»½å’Œæ¢å¤

**decoratorsï¼ˆ334è¡Œï¼‰**ï¼š
- `error_handler`ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†
- `log_execution`ï¼šæ‰§è¡Œæ—¥å¿—è®°å½•
- `performance_monitor`ï¼šæ€§èƒ½ç›‘æ§
- `retry_on_failure`ï¼šå¤±è´¥é‡è¯•
- `cache_result`ï¼šç»“æœç¼“å­˜
- `safe_execute`ï¼šç»„åˆè£…é¥°å™¨

**UIComponentsï¼ˆ384è¡Œï¼‰**ï¼š
- æ¨¡å‹å’Œå‚æ•°é€‰æ‹©å™¨
- RAGè®¾ç½®é¢æ¿
- æ–‡ä»¶ä¸Šä¼ å™¨
- èŠå¤©è®°å½•å±•ç¤º
- ç»Ÿè®¡å’Œå¯¼å‡ºç•Œé¢
- æ¶ˆæ¯æç¤ºç»„ä»¶

**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼š

| å·¥å…·ç±» | è®¾è®¡æ¨¡å¼ | æ ¸å¿ƒä»·å€¼ |
|-------|---------|---------|
| ChatHistoryManager | **ä»“å‚¨æ¨¡å¼** | æ•°æ®æŒä¹…åŒ–ã€CRUDç»Ÿä¸€æ¥å£ |
| decorators | **è£…é¥°å™¨æ¨¡å¼** | æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆæ—¥å¿—ã€å¼‚å¸¸ã€æ€§èƒ½ï¼‰ |
| UIComponents | **ç»„ä»¶æ¨¡å¼** | ç•Œé¢å¤ç”¨ã€ç»Ÿä¸€é£æ ¼ |

## ä¸ƒã€æœ¬è®²æ€»ç»“

æˆ‘ä»¬å®Œæˆäº†ä¸‰ä¸ªè¾…åŠ©å·¥å…·ç±»çš„å®ç°ï¼š

1. **èŠå¤©å†å²ç®¡ç†**ï¼šæŒä¹…åŒ–ã€å¯¼å‡ºã€æœç´¢ã€ç»Ÿè®¡
2. **è£…é¥°å™¨å·¥å…·é›†**ï¼šé”™è¯¯å¤„ç†ã€æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ã€é‡è¯•ã€ç¼“å­˜
3. **UIç»„ä»¶å°è£…**ï¼šç»Ÿä¸€Streamlitç»„ä»¶é£æ ¼ï¼Œç®€åŒ–è°ƒç”¨

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š
- JSONæŒä¹…åŒ–ï¼ˆèŠå¤©è®°å½•ï¼‰
- CSV/JSONå¯¼å‡ºï¼ˆæ•°æ®åˆ†æï¼‰
- è£…é¥°å™¨æ¨¡å¼ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰
- `@functools.wraps`ï¼ˆä¿ç•™å…ƒæ•°æ®ï¼‰
- Streamlitç»„ä»¶å°è£…ï¼ˆ`st.selectbox`ã€`st.slider`ç­‰ï¼‰
- æ€§èƒ½åˆ†çº§ç›‘æ§ï¼ˆwarning vs errorï¼‰

**æœ€ä½³å®è·µ**ï¼š
- æ•°æ®æŒä¹…åŒ–ï¼šæ¯æ¬¡æ·»åŠ ç«‹å³ä¿å­˜
- é”™è¯¯å¤„ç†ï¼šUIå±•ç¤º + æ—¥å¿—è®°å½•
- æ€§èƒ½ç›‘æ§ï¼šåˆ†çº§å‘Šè­¦ï¼ˆè­¦å‘Š/å‘Šè­¦ï¼‰
- UIç»„ä»¶ï¼š`key_prefix`é¿å…å†²çª
- è£…é¥°å™¨ï¼šç»„åˆä½¿ç”¨æå‡ä»£ç è´¨é‡

