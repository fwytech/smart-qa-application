# ç¬¬06ç« ï¼šè¾…åŠ©å·¥å…·ç±»(ä¸‹) - å¤©æ°”æŸ¥è¯¢ã€èŠå¤©å†å²ä¸UIç»„ä»¶

æœ¬ç« å®ç°ä¸‰ä¸ªæœåŠ¡æ¨¡å—ã€‚

## Part 1: å¤©æ°”æŸ¥è¯¢æœåŠ¡

**æ–‡ä»¶**ï¼š`services/weather_tools.py`ï¼ˆ331è¡Œï¼‰

é›†æˆé«˜å¾·åœ°å›¾APIï¼Œæä¾›å½“å‰å¤©æ°”å’Œå¤©æ°”é¢„æŠ¥åŠŸèƒ½ã€‚

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç </summary>

```python
import requests
import json
import logging
from typing import Dict, Optional, Any, List
from datetime import datetime
from config.settings import Settings

# è·å–æ—¥å¿—è®°å½•å™¨ ï¼šä»Pythonçš„loggingæ¨¡å—ä¸­è·å–ä¸€ä¸ªloggerå¯¹è±¡
# __name__ æ˜¯å½“å‰æ¨¡å—çš„åç§°ï¼ˆè¿™é‡Œæ˜¯ services.weather_tools ï¼‰
logger = logging.getLogger(__name__)

class WeatherService:
    """å¤©æ°”æŸ¥è¯¢æœåŠ¡ç±»"""

    def __init__(self):
        self.settings = Settings()
        self.api_key = self.settings.WEATHER_API_KEY
        self.weather_url = self.settings.WEATHER_API_URL
        self.city_url = self.settings.WEATHER_CITY_URL

        # åŸå¸‚ä»£ç ç¼“å­˜
        self.city_cache = {}

    def get_city_code(self, city_name: str) -> Optional[str]:
        """è·å–åŸå¸‚ä»£ç """
        """
        - ä½œç”¨ ï¼šæ ¹æ®åŸå¸‚åç§°è·å–å¯¹åº”çš„å¤©æ°”æ•°æ®æ¥å£åŸå¸‚ä»£ç 
        - ç•Œé¢å…ƒç´  ï¼šåŸå¸‚åç§°è¾“å…¥æ¡†
        - è¿”å› ï¼šåŸå¸‚ä»£ç ï¼ˆæˆåŠŸï¼‰æˆ– Noneï¼ˆå¤±è´¥ï¼‰
        """
        try:
            # æ£€æŸ¥ç¼“å­˜
            if city_name in self.city_cache:
                return self.city_cache[city_name]

            # æ„å»ºè¯·æ±‚URL
            url = f"{self.city_url}"
            params = {
                "keywords": city_name,
                "subdistrict": 0,
                "key": self.api_key,
                "extensions": "base"
            }

            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "1" and data.get("districts"):
                # è·å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„åŸå¸‚
                districts = data["districts"]
                if districts and len(districts) > 0:
                    city_code = districts[0].get("adcode")
                    if city_code:
                        # ç¼“å­˜ç»“æœ
                        self.city_cache[city_name] = city_code
                        logger.info(f"è·å–åŸå¸‚ä»£ç æˆåŠŸ: {city_name} -> {city_code}")
                        return city_code

            logger.warning(f"æœªæ‰¾åˆ°åŸå¸‚: {city_name}")
            return None

        except requests.RequestException as e:
            logger.error(f"è·å–åŸå¸‚ä»£ç å¤±è´¥: {str(e)}")
            return None
        except Exception as e:
            logger.error(f"è·å–åŸå¸‚ä»£ç å‡ºé”™: {str(e)}")
            return None

    def get_current_weather(self, city_name: str) -> str:
        """è·å–å½“å‰å¤©æ°”"""
        try:
            city_code = self.get_city_code(city_name)
            if not city_code:
                return f"æŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°åŸå¸‚ '{city_name}' çš„ä¿¡æ¯ã€‚è¯·æ£€æŸ¥åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"

            # æ„å»ºè¯·æ±‚URL
            params = {
                "city": city_code,
                "key": self.api_key,
                "extensions": "base"  # base=å®å†µå¤©æ°”
            }

            response = requests.get(self.weather_url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "1" and data.get("lives"):
                weather_info = data["lives"][0]

                # æ ¼å¼åŒ–å¤©æ°”ä¿¡æ¯
                result = self._format_current_weather(weather_info, city_name)
                logger.info(f"è·å–å½“å‰å¤©æ°”æˆåŠŸ: {city_name}")
                return result
            else:
                error_msg = data.get("info", "æœªçŸ¥é”™è¯¯")
                logger.warning(f"è·å–å½“å‰å¤©æ°”å¤±è´¥: {error_msg}")
                return f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: {error_msg}"

        except requests.RequestException as e:
            error_msg = f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}"
            logger.error(f"è·å–å½“å‰å¤©æ°”å¤±è´¥: {error_msg}")
            return f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"
        except Exception as e:
            error_msg = f"è·å–å½“å‰å¤©æ°”å‡ºé”™: {str(e)}"
            logger.error(error_msg)
            return f"è·å–å¤©æ°”ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"

    def get_weather_forecast(self, city_name: str, days: int = 3) -> str:
        """è·å–å¤©æ°”é¢„æŠ¥"""
        """
        - ä½œç”¨ ï¼šæ ¹æ®åŸå¸‚åç§°è·å–æœªæ¥å‡ å¤©çš„å¤©æ°”é¢„æŠ¥
        - ç•Œé¢å…ƒç´  ï¼šåŸå¸‚åç§°è¾“å…¥æ¡† + é¢„æŠ¥å¤©æ•°é€‰æ‹©å™¨
        - è¿”å› ï¼šå¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²ï¼ˆæˆåŠŸï¼‰æˆ–é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥ï¼‰
        """
        try:
            if days < 1 or days > 7:
                return "é¢„æŠ¥å¤©æ•°å¿…é¡»åœ¨1-7å¤©ä¹‹é—´ã€‚"

            city_code = self.get_city_code(city_name)
            if not city_code:
                return f"æŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°åŸå¸‚ '{city_name}' çš„ä¿¡æ¯ã€‚è¯·æ£€æŸ¥åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"

            # æ„å»ºè¯·æ±‚URL
            params = {
                "city": city_code,
                "key": self.api_key,
                "extensions": "all"  # all=é¢„æŠ¥å¤©æ°”
            }

            response = requests.get(self.weather_url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "1" and data.get("forecasts"):
                forecast_info = data["forecasts"][0]

                # æ ¼å¼åŒ–é¢„æŠ¥ä¿¡æ¯
                result = self._format_weather_forecast(forecast_info, city_name, days)
                logger.info(f"è·å–å¤©æ°”é¢„æŠ¥æˆåŠŸ: {city_name}, å¤©æ•°: {days}")
                return result
            else:
                error_msg = data.get("info", "æœªçŸ¥é”™è¯¯")
                logger.warning(f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}")
                return f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}"

        except requests.RequestException as e:
            error_msg = f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}"
            logger.error(f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}")
            return f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"
        except Exception as e:
            error_msg = f"è·å–å¤©æ°”é¢„æŠ¥å‡ºé”™: {str(e)}"
            logger.error(error_msg)
            return f"è·å–å¤©æ°”é¢„æŠ¥æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"    

    def _format_current_weather(self, weather_data: Dict[str, Any], city_name: str) -> str:
        """æ ¼å¼åŒ–å½“å‰å¤©æ°”ä¿¡æ¯"""
        """
        - ä½œç”¨ ï¼šå°†å¤©æ°”æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„å­—ç¬¦ä¸²
        - ç•Œé¢å…ƒç´  ï¼šåŸå¸‚åç§° + å½“å‰å¤©æ°”æ•°æ®
        - è¿”å› ï¼šæ ¼å¼åŒ–åçš„å¤©æ°”å­—ç¬¦ä¸²
        """
        try:
            province = weather_data.get("province", "")
            city = weather_data.get("city", city_name)
            weather = weather_data.get("weather", "")
            temperature = weather_data.get("temperature", "")
            winddirection = weather_data.get("winddirection", "")
            windpower = weather_data.get("windpower", "")
            humidity = weather_data.get("humidity", "")
            reporttime = weather_data.get("reporttime", "")

            # æ„å»ºæ ¼å¼åŒ–è¾“å‡º
            result = f"ğŸ™ï¸ **{province} {city}** å½“å‰å¤©æ°”\n\n"
            result += f"ğŸŒ¤ï¸ **å¤©æ°”çŠ¶å†µ**: {weather}\n"
            result += f"ğŸŒ¡ï¸ **æ°”æ¸©**: {temperature}Â°C\n"
            result += f"ğŸ’¨ **é£å‘é£åŠ›**: {winddirection} {windpower}\n"
            result += f"ğŸ’§ **æ¹¿åº¦**: {humidity}%\n"
            result += f"ğŸ“… **å‘å¸ƒæ—¶é—´**: {reporttime}\n"

            # æ·»åŠ å¤©æ°”å»ºè®®
            result += "\nğŸ’¡ **æ¸©é¦¨æç¤º**:\n"

            if temperature and temperature.isdigit():
                temp = int(temperature)
                if temp < 10:
                    result += "â€¢ å¤©æ°”è¾ƒå†·ï¼Œè¯·æ³¨æ„ä¿æš–ã€‚\n"
                elif temp > 30:
                    result += "â€¢ å¤©æ°”è¾ƒçƒ­ï¼Œè¯·æ³¨æ„é˜²æš‘ã€‚\n"
                else:
                    result += "â€¢ å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå¤–å‡ºã€‚\n"

            if humidity and humidity.isdigit():
                hum = int(humidity)
                if hum > 80:
                    result += "â€¢ æ¹¿åº¦è¾ƒé«˜ï¼Œæ³¨æ„é˜²æ½®ã€‚\n"
                elif hum < 30:
                    result += "â€¢ æ¹¿åº¦è¾ƒä½ï¼Œæ³¨æ„è¡¥æ°´ã€‚\n"

            return result

        except Exception as e:
            logger.error(f"æ ¼å¼åŒ–å½“å‰å¤©æ°”ä¿¡æ¯å¤±è´¥: {str(e)}")
            return f"å¤©æ°”æ•°æ®æ ¼å¼åŒ–å¤±è´¥: {str(e)}"

    def _format_weather_forecast(self, forecast_data: Dict[str, Any], city_name: str, days: int) -> str:
        """æ ¼å¼åŒ–å¤©æ°”é¢„æŠ¥ä¿¡æ¯"""
        """
        - ä½œç”¨ ï¼šå°†é¢„æŠ¥æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„å­—ç¬¦ä¸²
        - ç•Œé¢å…ƒç´  ï¼šåŸå¸‚åç§° + é¢„æŠ¥å¤©æ•°
        - è¿”å› ï¼šæ ¼å¼åŒ–åçš„é¢„æŠ¥å­—ç¬¦ä¸²
        """
        try:
            province = forecast_data.get("province", "")
            city = forecast_data.get("city", city_name)
            reporttime = forecast_data.get("reporttime", "")
            casts = forecast_data.get("casts", [])

            result = f"ğŸ™ï¸ **{province} {city}** æœªæ¥{days}å¤©å¤©æ°”é¢„æŠ¥\n\n"
            result += f"ğŸ“… **å‘å¸ƒæ—¶é—´**: {reporttime}\n\n"

            # åªæ˜¾ç¤ºæŒ‡å®šå¤©æ•°
            for i, cast in enumerate(casts[:days]):
                date = cast.get("date", "")
                week = cast.get("week", "")
                dayweather = cast.get("dayweather", "")
                nightweather = cast.get("nightweather", "")
                daytemp = cast.get("daytemp", "")
                nighttemp = cast.get("nighttemp", "")
                daywind = cast.get("daywind", "")
                nightwind = cast.get("nightwind", "")
                daypower = cast.get("daypower", "")
                nightpower = cast.get("nightpower", "")

                result += f"ğŸ“… **{date}** ({week})\n"
                result += f"ğŸŒ¤ï¸ **å¤©æ°”**: ç™½å¤©{dayweather}ï¼Œå¤œé—´{nightweather}\n"
                result += f"ğŸŒ¡ï¸ **æ¸©åº¦**: ç™½å¤©{daytemp}Â°Cï¼Œå¤œé—´{nighttemp}Â°C\n"
                result += f"ğŸ’¨ **é£åŠ›**: ç™½å¤©{daywind}{daypower}ï¼Œå¤œé—´{nightwind}{nightpower}\n"
                
                if i < days - 1:  # ä¸æ˜¯æœ€åä¸€å¤©å°±åŠ åˆ†å‰²çº¿
                    result += "\n" + "â”€" * 30 + "\n\n"

            return result

        except Exception as e:
            logger.error(f"æ ¼å¼åŒ–å¤©æ°”é¢„æŠ¥ä¿¡æ¯å¤±è´¥: {str(e)}")
            return f"é¢„æŠ¥æ•°æ®æ ¼å¼åŒ–å¤±è´¥: {str(e)}"


if __name__ == "__main__":
    """
    å¤©æ°”æœåŠ¡æµ‹è¯•ä»£ç 
    è¿è¡Œæ–¹æ³•ï¼špython services/weather_tools.py
    """
    import logging
    
    # é…ç½®æ—¥å¿—æ˜¾ç¤º
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    print("ğŸŒ¤ï¸ å¤©æ°”æœåŠ¡æµ‹è¯•å¼€å§‹...")
    print("=" * 50)
    
    # åˆ›å»ºå¤©æ°”æœåŠ¡å®ä¾‹
    weather_service = WeatherService()
    
    # æµ‹è¯•1ï¼šè·å–åŸå¸‚ä»£ç 
    print("\nğŸ“ æµ‹è¯•1ï¼šè·å–åŸå¸‚ä»£ç ")
    print("-" * 30)
    test_cities = ["åŒ—äº¬", "ä¸Šæµ·"]
    
    for city in test_cities:
        city_code = weather_service.get_city_code(city)
        if city_code:
            print(f"âœ… {city}: {city_code}")
        else:
            print(f"âŒ {city}: æœªæ‰¾åˆ°åŸå¸‚ä»£ç ")
    
    # æµ‹è¯•2ï¼šè·å–å½“å‰å¤©æ°”
    print("\nğŸŒ¡ï¸ æµ‹è¯•2ï¼šè·å–å½“å‰å¤©æ°”")
    print("-" * 30)
    
    for city in test_cities[:3]:  # åªæµ‹è¯•å‰3ä¸ªåŸå¸‚
        print(f"\nğŸŒ {city}å½“å‰å¤©æ°”ï¼š")
        weather_info = weather_service.get_current_weather(city)
        print(weather_info)
        print("-" * 30)
    
    # æµ‹è¯•3ï¼šè·å–å¤©æ°”é¢„æŠ¥
    print("\nğŸ“… æµ‹è¯•3ï¼šè·å–å¤©æ°”é¢„æŠ¥")
    print("-" * 30)
    
    for city in test_cities[:2]:  # åªæµ‹è¯•å‰2ä¸ªåŸå¸‚
        for days in [1, 3, 5]:
            print(f"\nğŸŒˆ {city}æœªæ¥{days}å¤©é¢„æŠ¥ï¼š")
            forecast_info = weather_service.get_weather_forecast(city, days)
            print(forecast_info)
            print("-" * 30)
    
    # æµ‹è¯•4ï¼šé”™è¯¯å¤„ç†
    print("\nâš ï¸ æµ‹è¯•4ï¼šé”™è¯¯å¤„ç†")
    print("-" * 30)
    
    # æµ‹è¯•ä¸å­˜åœ¨çš„åŸå¸‚
    fake_city = "ä¸å­˜åœ¨çš„åŸå¸‚123"
    result = weather_service.get_current_weather(fake_city)
    print(f"æŸ¥è¯¢ä¸å­˜åœ¨çš„åŸå¸‚ '{fake_city}':")
    print(result)
    
    # æµ‹è¯•æ— æ•ˆçš„é¢„æŠ¥å¤©æ•°
    result = weather_service.get_weather_forecast("åŒ—äº¬", 0)
    print(f"\né¢„æŠ¥å¤©æ•°ä¸º0ï¼š")
    print(result)
    
    result = weather_service.get_weather_forecast("åŒ—äº¬", 10)
    print(f"\né¢„æŠ¥å¤©æ•°ä¸º10ï¼š")
    print(result)
    
    print("\n" + "=" * 50)
    print("ğŸ‰ å¤©æ°”æœåŠ¡æµ‹è¯•å®Œæˆï¼")
    print("\nğŸ’¡ æµ‹è¯•ç»“æœè¯´æ˜ï¼š")
    print("â€¢ âœ… è¡¨ç¤ºåŠŸèƒ½æ­£å¸¸")
    print("â€¢ âŒ è¡¨ç¤ºæœ‰é”™è¯¯æˆ–æ‰¾ä¸åˆ°æ•°æ®")
    print("â€¢ å¦‚æœçœ‹åˆ°å¤©æ°”ä¿¡æ¯ï¼Œè¯´æ˜APIè°ƒç”¨æˆåŠŸ")
    print("â€¢ å¦‚æœçœ‹åˆ°é”™è¯¯æç¤ºï¼Œè¯´æ˜é”™è¯¯å¤„ç†æœºåˆ¶å·¥ä½œæ­£å¸¸")```

</details>

## Part 2: èŠå¤©å†å²ç®¡ç†

**æ–‡ä»¶**ï¼š`utils/chat_history.py`ï¼ˆ488è¡Œï¼‰

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç </summary>

```python
import json
import os
import csv
import logging
from typing import List, Dict, Optional, Any
from datetime import datetime
from pathlib import Path
from config.settings import Settings

logger = logging.getLogger(__name__)

class ChatHistoryManager:
    """èŠå¤©è®°å½•ç®¡ç†å™¨"""

    def __init__(self, history_file: str = None):
        """åˆå§‹åŒ–èŠå¤©è®°å½•ç®¡ç†å™¨
        
        æ–¹æ³•ç”¨é€”ï¼šåˆ›å»ºChatHistoryManagerå®ä¾‹ï¼Œè®¾ç½®å†å²æ–‡ä»¶è·¯å¾„ï¼ŒåŠ è½½ç°æœ‰è®°å½•
        
        å‚æ•°è§£é‡Šï¼š
            history_file (str, å¯é€‰): å†å²è®°å½•æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºNoneåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤è·¯å¾„
            
        è¿”å›å€¼ï¼šæ— ï¼ˆæ„é€ å‡½æ•°ï¼‰
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> # ä½¿ç”¨é»˜è®¤è·¯å¾„
            >>> manager = ChatHistoryManager()
            >>> print(manager.history_file)  # è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤è·¯å¾„
            >>> 
            >>> # ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„
            >>> custom_manager = ChatHistoryManager('my_chat_history.json')
            >>> print(custom_manager.history_file)  # è¿”å›: 'my_chat_history.json'
            >>> 
            >>> # è‡ªåŠ¨åˆ›å»ºç›®å½•
            >>> manager = ChatHistoryManager('data/chats/history.json')
            >>> # å¦‚æœdata/chatsç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
        """
        self.settings = Settings()
        self.history_file = history_file or self.settings.CHAT_HISTORY_PATH
        self.history_dir = Path(self.history_file).parent
        self.history_dir.mkdir(parents=True, exist_ok=True)
        self.chat_history = []
        self.max_history_size = 10000  # æœ€å¤§å†å²è®°å½•æ•°

        # åŠ è½½ç°æœ‰å†å²è®°å½•
        self.load_history()

    def add_message(self, role: str, content: str, metadata: Dict[str, Any] = None) -> bool:
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šå°†ä¸€æ¡æ–°çš„èŠå¤©æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•ä¸­ï¼Œå¹¶è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
        
        å‚æ•°è§£é‡Šï¼š
            role (str): æ¶ˆæ¯è§’è‰²ï¼Œå¦‚ 'user', 'assistant', 'system'
            content (str): æ¶ˆæ¯å†…å®¹
            metadata (Dict[str, Any], å¯é€‰): æ¶ˆæ¯çš„å…ƒæ•°æ®ï¼Œå¦‚æ¨¡å‹ä¿¡æ¯ã€æ¸©åº¦ç­‰
            
        è¿”å›å€¼ï¼š
            bool: æ·»åŠ æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> success = manager.add_message('user', 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Python')
            >>> print(success)  # è¿”å›: True
            
            >>> success = manager.add_message('assistant', 'Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€...', 
            ...                                {'model': 'gpt-4', 'temperature': 0.7})
            >>> print(success)  # è¿”å›: True
        """
        try:
            message = {
                "role": role,
                "content": content,
                "timestamp": datetime.now().isoformat(),
                "id": self._generate_message_id()
            }

            if metadata:
                message["metadata"] = metadata

            self.chat_history.append(message)

            # å¦‚æœè¶…è¿‡æœ€å¤§æ•°é‡ï¼Œç§»é™¤æœ€æ—§çš„è®°å½•
            if len(self.chat_history) > self.max_history_size:
                self.chat_history.pop(0)

            # ä¿å­˜åˆ°æ–‡ä»¶
            self.save_history()

            logger.debug(f"æ·»åŠ æ¶ˆæ¯æˆåŠŸ: {role}")
            return True

        except Exception as e:
            logger.error(f"æ·»åŠ æ¶ˆæ¯å¤±è´¥: {str(e)}")
            return False

    def get_history(self, limit: int = None, role_filter: str = None) -> List[Dict[str, Any]]:
        """è·å–å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šè·å–èŠå¤©è®°å½•ï¼Œæ”¯æŒæŒ‰è§’è‰²è¿‡æ»¤å’Œæ•°é‡é™åˆ¶
        
        å‚æ•°è§£é‡Šï¼š
            limit (int, å¯é€‰): è¿”å›çš„æœ€å¤§è®°å½•æ•°ï¼ŒNoneè¡¨ç¤ºè¿”å›æ‰€æœ‰è®°å½•
            role_filter (str, å¯é€‰): è§’è‰²è¿‡æ»¤å™¨ï¼Œå¦‚ 'user', 'assistant'ï¼ŒNoneè¡¨ç¤ºä¸è¿‡æ»¤
            
        è¿”å›å€¼ï¼š
            List[Dict[str, Any]]: æ¶ˆæ¯åˆ—è¡¨ï¼Œæ¯æ¡æ¶ˆæ¯åŒ…å«roleã€contentã€timestampã€idç­‰å­—æ®µ
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½')
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ')
            >>> 
            >>> # è·å–æ‰€æœ‰å†å²è®°å½•
            >>> all_history = manager.get_history()
            >>> print(len(all_history))  # è¿”å›: 2
            >>> 
            >>> # è·å–æœ€è¿‘1æ¡è®°å½•
            >>> recent = manager.get_history(limit=1)
            >>> print(recent[0]['role'])  # è¿”å›: 'assistant'
            >>> 
            >>> # åªè·å–ç”¨æˆ·æ¶ˆæ¯
            >>> user_msgs = manager.get_history(role_filter='user')
            >>> print(len(user_msgs))  # è¿”å›: 1
        """
        try:
            history = self.chat_history.copy()

            # è§’è‰²è¿‡æ»¤
            if role_filter:
                history = [msg for msg in history if msg.get("role") == role_filter]

            # æ•°é‡é™åˆ¶
            if limit and limit > 0:
                history = history[-limit:]

            return history

        except Exception as e:
            logger.error(f"è·å–å†å²è®°å½•å¤±è´¥: {str(e)}")
            return []

    def clear_history(self) -> bool:
        """æ¸…ç©ºå†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šæ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ï¼Œå¹¶åˆ é™¤ä¿å­˜çš„å†å²æ–‡ä»¶
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: æ¸…ç©ºæˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½')
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼')
            >>> print(len(manager.get_history()))  # è¿”å›: 2
            >>> 
            >>> # æ¸…ç©ºå†å²è®°å½•
            >>> success = manager.clear_history()
            >>> print(success)  # è¿”å›: True
            >>> print(len(manager.get_history()))  # è¿”å›: 0
        """
        try:
            self.chat_history = []
            self.save_history()

            logger.info("æ¸…ç©ºå†å²è®°å½•æˆåŠŸ")
            return True

        except Exception as e:
            logger.error(f"æ¸…ç©ºå†å²è®°å½•å¤±è´¥: {str(e)}")
            return False

    def export_to_csv(self, output_file: str = None) -> str:
        """å¯¼å‡ºä¸ºCSVæ ¼å¼
        
        æ–¹æ³•ç”¨é€”ï¼šå°†èŠå¤©è®°å½•å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼Œå¯ä»¥è¿”å›CSVå­—ç¬¦ä¸²æˆ–ä¿å­˜åˆ°æ–‡ä»¶
        
        å‚æ•°è§£é‡Šï¼š
            output_file (str, å¯é€‰): è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºNoneåˆ™è¿”å›CSVå­—ç¬¦ä¸²
            
        è¿”å›å€¼ï¼š
            str: å¦‚æœoutput_fileä¸ºNoneï¼Œè¿”å›CSVå­—ç¬¦ä¸²ï¼›å¦åˆ™è¿”å›æ–‡ä»¶è·¯å¾„
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'ä½ å¥½', {'model': 'gpt-4'})
            >>> manager.add_message('assistant', 'ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ')
            >>> 
            >>> # å¯¼å‡ºä¸ºCSVå­—ç¬¦ä¸²
            >>> csv_content = manager.export_to_csv()
            >>> print(csv_content[:50])  # è¿”å›: 'role,content,timestamp,id,metadata\\r\\nuser,ä½ å¥½,...'
            >>> 
            >>> # ä¿å­˜åˆ°æ–‡ä»¶
            >>> file_path = manager.export_to_csv('chat_history.csv')
            >>> print(file_path)  # è¿”å›: 'chat_history.csv'
        """
        try:
            if not output_file:
                # è¿”å›CSVå­—ç¬¦ä¸²
                import io
                output = io.StringIO()

                if self.chat_history:
                    # å®šä¹‰æ ‡å‡†CSVå­—æ®µï¼Œæ’é™¤å¤æ‚çš„metadataå­—æ®µ
                    standard_fields = ['role', 'content', 'timestamp', 'id']
                    writer = csv.DictWriter(output, fieldnames=standard_fields)
                    writer.writeheader()
                    
                    # åªå¯¼å‡ºæ ‡å‡†å­—æ®µ
                    for message in self.chat_history:
                        row = {field: message.get(field, '') for field in standard_fields}
                        writer.writerow(row)

                csv_content = output.getvalue()
                output.close()

                logger.info("å¯¼å‡ºCSVæˆåŠŸ")
                return csv_content
            else:
                # ä¿å­˜åˆ°æ–‡ä»¶
                with open(output_file, 'w', newline='', encoding='utf-8') as f:
                    if self.chat_history:
                        # å®šä¹‰æ ‡å‡†CSVå­—æ®µï¼Œæ’é™¤å¤æ‚çš„metadataå­—æ®µ
                        standard_fields = ['role', 'content', 'timestamp', 'id']
                        writer = csv.DictWriter(f, fieldnames=standard_fields)
                        writer.writeheader()
                        
                        # åªå¯¼å‡ºæ ‡å‡†å­—æ®µ
                        for message in self.chat_history:
                            row = {field: message.get(field, '') for field in standard_fields}
                            writer.writerow(row)

                logger.info(f"å¯¼å‡ºCSVæ–‡ä»¶æˆåŠŸ: {output_file}")
                return output_file

        except Exception as e:
            logger.error(f"å¯¼å‡ºCSVå¤±è´¥: {str(e)}")
            return ""

    def search_history(self, keyword: str, role_filter: str = None) -> List[Dict[str, Any]]:
        """æœç´¢å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šæ ¹æ®å…³é”®è¯æœç´¢èŠå¤©è®°å½•ï¼Œæ”¯æŒæŒ‰è§’è‰²è¿‡æ»¤
        
        å‚æ•°è§£é‡Šï¼š
            keyword (str): æœç´¢å…³é”®è¯ï¼Œä¸åŒºåˆ†å¤§å°å†™
            role_filter (str, å¯é€‰): è§’è‰²è¿‡æ»¤å™¨ï¼Œå¦‚ 'user', 'assistant'ï¼ŒNoneè¡¨ç¤ºä¸è¿‡æ»¤
            
        è¿”å›å€¼ï¼š
            List[Dict[str, Any]]: åŒ¹é…çš„æ¶ˆæ¯åˆ—è¡¨
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'Pythonæ˜¯ä»€ä¹ˆï¼Ÿ')
            >>> manager.add_message('assistant', 'Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€')
            >>> manager.add_message('user', 'Javaæ˜¯ä»€ä¹ˆï¼Ÿ')
            >>> 
            >>> # æœç´¢åŒ…å«"Python"çš„è®°å½•
            >>> results = manager.search_history('python')
            >>> print(len(results))  # è¿”å›: 2ï¼ˆç”¨æˆ·é—®é¢˜å’ŒåŠ©æ‰‹å›ç­”ï¼‰
            >>> 
            >>> # åªæœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­åŒ…å«"æ˜¯ä»€ä¹ˆ"çš„è®°å½•
            >>> user_results = manager.search_history('æ˜¯ä»€ä¹ˆ', role_filter='user')
            >>> print(len(user_results))  # è¿”å›: 2
            >>> 
            >>> # æœç´¢ä¸å­˜åœ¨çš„å…³é”®è¯
            >>> empty_results = manager.search_history('ä¸å­˜åœ¨çš„è¯')
            >>> print(len(empty_results))  # è¿”å›: 0
        """
        try:
            results = []
            keyword = keyword.lower()

            for message in self.chat_history:
                # è§’è‰²è¿‡æ»¤
                if role_filter and message.get("role") != role_filter:
                    continue

                # å†…å®¹æœç´¢
                content = message.get("content", "").lower()
                if keyword in content:
                    results.append(message)

            logger.info(f"æœç´¢å†å²è®°å½•: '{keyword}' - æ‰¾åˆ° {len(results)} æ¡ç»“æœ")
            return results

        except Exception as e:
            logger.error(f"æœç´¢å†å²è®°å½•å¤±è´¥: {str(e)}")
            return []

    def load_history(self) -> bool:
        """åŠ è½½å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šä»JSONæ–‡ä»¶åŠ è½½èŠå¤©è®°å½•åˆ°å†…å­˜ä¸­
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: åŠ è½½æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> success = manager.load_history()
            >>> print(success)  # è¿”å›: Trueï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼‰
            >>> 
            >>> # åŠ è½½åå¯ä»¥åœ¨å†…å­˜ä¸­è®¿é—®å†å²è®°å½•
            >>> history = manager.get_history()
            >>> print(len(history))  # è¿”å›å†å²è®°å½•æ•°é‡
        """
        try:
            if os.path.exists(self.history_file):
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.chat_history = json.load(f)
                logger.info(f"åŠ è½½å†å²è®°å½•æˆåŠŸ: {len(self.chat_history)} æ¡è®°å½•")
            else:
                self.chat_history = []
                logger.info("å†å²è®°å½•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨")
            return True
        except Exception as e:
            logger.error(f"åŠ è½½å†å²è®°å½•å¤±è´¥: {str(e)}")
            self.chat_history = []
            return False

    def save_history(self) -> bool:
        """ä¿å­˜å†å²è®°å½•
        
        æ–¹æ³•ç”¨é€”ï¼šå°†å†…å­˜ä¸­çš„èŠå¤©è®°å½•ä¿å­˜åˆ°JSONæ–‡ä»¶
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            bool: ä¿å­˜æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> manager.add_message('user', 'æµ‹è¯•æ¶ˆæ¯')
            >>> success = manager.save_history()
            >>> print(success)  # è¿”å›: True
            >>> 
            >>> # ä¿å­˜åå¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çœ‹åˆ°å†å²æ–‡ä»¶
            >>> import os
            >>> print(os.path.exists(manager.history_file))  # è¿”å›: True
        """
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.chat_history, f, ensure_ascii=False, indent=2)
            logger.debug(f"ä¿å­˜å†å²è®°å½•æˆåŠŸ: {len(self.chat_history)} æ¡è®°å½•")
            return True
        except Exception as e:
            logger.error(f"ä¿å­˜å†å²è®°å½•å¤±è´¥: {str(e)}")
            return False

    def _generate_message_id(self) -> str:
        """ç”Ÿæˆæ¶ˆæ¯ID
        
        æ–¹æ³•ç”¨é€”ï¼šä¸ºæ¯æ¡æ¶ˆæ¯ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰
        
        å‚æ•°ï¼šæ— 
        
        è¿”å›å€¼ï¼š
            str: 36ä½çš„UUIDå­—ç¬¦ä¸²
            
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            >>> manager = ChatHistoryManager()
            >>> msg_id = manager._generate_message_id()
            >>> print(msg_id)  # è¿”å›: '550e8400-e29b-41d4-a716-446655440000'
            >>> print(len(msg_id))  # è¿”å›: 36
            >>> 
            >>> # æ¯æ¬¡è°ƒç”¨éƒ½ä¼šç”Ÿæˆä¸åŒçš„ID
            >>> id1 = manager._generate_message_id()
            >>> id2 = manager._generate_message_id()
            >>> print(id1 == id2)  # è¿”å›: False
        """
        import uuid
        return str(uuid.uuid4())


if __name__ == "__main__":
    """ChatHistoryManager ç±»çš„å®Œæ•´æµ‹è¯•"""
    
    import tempfile
    import os
    
    print("ğŸš€ å¼€å§‹æµ‹è¯• ChatHistoryManager ç±»...\n")
    
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºæµ‹è¯•
    with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as tmp_file:
        temp_history_file = tmp_file.name
    
    try:
        # 1. æµ‹è¯•åˆå§‹åŒ–
        print("ğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–ç®¡ç†å™¨")
        manager = ChatHistoryManager(history_file=temp_history_file)
        print(f"   âœ… åˆå§‹åŒ–æˆåŠŸï¼Œå†å²æ–‡ä»¶: {manager.history_file}")
        
        # 2. æµ‹è¯•æ·»åŠ æ¶ˆæ¯
        print("\nğŸ’¬ æµ‹è¯•2: æ·»åŠ æ¶ˆæ¯")
        manager.add_message("user", "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹Python")
        manager.add_message("assistant", "Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œå…·æœ‰ç®€æ´æ˜“è¯»çš„è¯­æ³•ç‰¹ç‚¹ã€‚", 
                          metadata={"model": "gpt-4", "temperature": 0.7})
        manager.add_message("user", "Pythoné€‚åˆåšä»€ä¹ˆç±»å‹çš„é¡¹ç›®ï¼Ÿ")
        manager.add_message("assistant", "Pythoné€‚åˆæ•°æ®åˆ†æã€Webå¼€å‘ã€äººå·¥æ™ºèƒ½ã€è‡ªåŠ¨åŒ–è„šæœ¬ç­‰å¤šç§åº”ç”¨åœºæ™¯ã€‚",
                          metadata={"model": "gpt-5", "confidence": 0.95})
        print(f"   âœ… æˆåŠŸæ·»åŠ  {len(manager.get_history())} æ¡æ¶ˆæ¯")
        
        # 3. æµ‹è¯•è·å–å†å²è®°å½•
        print("\nğŸ“– æµ‹è¯•3: è·å–å†å²è®°å½•")
        full_history = manager.get_history()
        print(f"   âœ… è·å–å®Œæ•´å†å²: {len(full_history)} æ¡è®°å½•")
        
        user_messages = manager.get_history(role_filter="user")
        print(f"   âœ… è·å–ç”¨æˆ·æ¶ˆæ¯: {len(user_messages)} æ¡è®°å½•")
        
        assistant_messages = manager.get_history(role_filter="assistant", limit=1)
        print(f"   âœ… è·å–æœ€æ–°åŠ©æ‰‹æ¶ˆæ¯: {len(assistant_messages)} æ¡è®°å½•")
        
        # 4. æµ‹è¯•æœç´¢åŠŸèƒ½
        print("\nğŸ” æµ‹è¯•4: æœç´¢åŠŸèƒ½")
        python_results = manager.search_history("Python")
        print(f"   âœ… æœç´¢ 'Python': æ‰¾åˆ° {len(python_results)} æ¡ç»“æœ")
        
        project_results = manager.search_history("é¡¹ç›®", role_filter="user")
        print(f"   âœ… æœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ 'é¡¹ç›®': æ‰¾åˆ° {len(project_results)} æ¡ç»“æœ")
        
        no_results = manager.search_history("JavaScript")
        print(f"   âœ… æœç´¢ 'JavaScript': æ‰¾åˆ° {len(no_results)} æ¡ç»“æœ")
        
        # 5. æµ‹è¯•å¯¼å‡ºåŠŸèƒ½
        print("\nğŸ“Š æµ‹è¯•5: å¯¼å‡ºåŠŸèƒ½")
        csv_content = manager.export_to_csv()
        print(f"   âœ… å¯¼å‡ºCSVå­—ç¬¦ä¸²: {len(csv_content)} å­—ç¬¦")
        
        csv_file = temp_history_file.replace('.json', '.csv')
        csv_path = manager.export_to_csv(csv_file)
        print(f"   âœ… ä¿å­˜CSVæ–‡ä»¶: {csv_path}")
        
        # 6. æµ‹è¯•ä¿å­˜å’ŒåŠ è½½
        print("\nğŸ’¾ æµ‹è¯•6: ä¿å­˜å’ŒåŠ è½½")
        save_success = manager.save_history()
        print(f"   âœ… ä¿å­˜å†å²è®°å½•: {save_success}")
        
        # åˆ›å»ºæ–°ç®¡ç†å™¨å®ä¾‹å¹¶åŠ è½½
        new_manager = ChatHistoryManager(history_file=temp_history_file)
        load_success = new_manager.load_history()
        print(f"   âœ… åŠ è½½å†å²è®°å½•: {load_success}")
        print(f"   âœ… åŠ è½½åè®°å½•æ•°: {len(new_manager.get_history())}")
        
        # 7. æµ‹è¯•æ¸…ç©ºå†å²
        print("\nğŸ—‘ï¸ æµ‹è¯•7: æ¸…ç©ºå†å²è®°å½•")
        clear_success = new_manager.clear_history()
        print(f"   âœ… æ¸…ç©ºå†å²è®°å½•: {clear_success}")
        print(f"   âœ… æ¸…ç©ºåè®°å½•æ•°: {len(new_manager.get_history())}")
        
        # 8. æµ‹è¯•æ¶ˆæ¯IDç”Ÿæˆ
        print("\nğŸ†” æµ‹è¯•8: æ¶ˆæ¯IDç”Ÿæˆ")
        msg_id = manager._generate_message_id()
        print(f"   âœ… ç”Ÿæˆæ¶ˆæ¯ID: {msg_id}")
        print(f"   âœ… IDé•¿åº¦: {len(msg_id)} å­—ç¬¦")
        
        # 9. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
        print("\nâš¡ æµ‹è¯•9: è¾¹ç•Œæƒ…å†µ")
        empty_manager = ChatHistoryManager(history_file="non_existent_file.json")
        empty_manager.load_history()  # åº”è¯¥èƒ½å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶
        print(f"   âœ… å¤„ç†ä¸å­˜åœ¨çš„æ–‡ä»¶: {len(empty_manager.get_history())} æ¡è®°å½•")
        
        empty_results = empty_manager.search_history("ä»»ä½•å†…å®¹")
        print(f"   âœ… æœç´¢ç©ºå†å²: {len(empty_results)} æ¡ç»“æœ")
        
        empty_csv = empty_manager.export_to_csv()
        print(f"   âœ… å¯¼å‡ºç©ºå†å²: '{empty_csv}'")
        
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼ChatHistoryManager ç±»å·¥ä½œæ­£å¸¸ï¼")
        
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {str(e)}")
        import traceback
        traceback.print_exc()
        
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if os.path.exists(temp_history_file):
            os.unlink(temp_history_file)
        csv_file = temp_history_file.replace('.json', '.csv')
        if os.path.exists(csv_file):
            os.unlink(csv_file)
        print(f"\nğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆ")```

</details>

## Part 3: UIç»„ä»¶åº“

**æ–‡ä»¶**ï¼š`utils/ui_components.py`ï¼ˆ139è¡Œï¼‰

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç </summary>

```python
import streamlit as st
from typing import List, Dict, Optional, Any
from config.settings import Settings

class UIComponents:
    """UIç»„ä»¶ç±» - è´Ÿè´£æ¸²æŸ“å„ç§Streamlitç•Œé¢å…ƒç´ """

    def __init__(self):
        self.settings = Settings()

    
    def render_model_selector(self, current_model: str, key_prefix: str = "") -> str:
        """æ¸²æŸ“æ¨¡å‹é€‰æ‹©å™¨"""
        """
        - ä½œç”¨ ï¼šè®©ç”¨æˆ·é€‰æ‹©AIæ¨¡å‹
        - ç•Œé¢å…ƒç´  ï¼šä¸‹æ‹‰é€‰æ‹©æ¡† + åˆ·æ–°æŒ‰é’®
        - è¿”å› ï¼šç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹åç§°
        """
        col1, col2 = st.columns([2, 1])

        with col1:
            selected_model = st.selectbox(
                "ğŸ¤– é€‰æ‹©æ¨¡å‹",
                options=self.settings.AVAILABLE_MODELS,
                index=self.settings.AVAILABLE_MODELS.index(current_model)
                if current_model in self.settings.AVAILABLE_MODELS else 0,
                help="é€‰æ‹©è¦ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹",
                key=f"{key_prefix}model_selector"
            )

        with col2:
            if st.button("ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨", key=f"{key_prefix}refresh_models"):
                st.rerun()

        return selected_model

    def render_temperature_slider(self, current_temp: float, key_prefix: str = "") -> float:
        """æ¸²æŸ“æ¸©åº¦ç³»æ•°æ»‘å—"""
        """
        - ä½œç”¨ ï¼šæ§åˆ¶AIå›ç­”çš„éšæœºæ€§ï¼ˆ0.0-1.0ï¼‰
        - ç•Œé¢å…ƒç´  ï¼šæ»‘å— + æ™ºèƒ½æç¤º
        - è¿”å› ï¼šæ¸©åº¦å€¼
        """
        temperature = st.slider(
            "ğŸŒ¡ï¸ æ¸©åº¦ç³»æ•° (Temperature)",
            min_value=0.0,
            max_value=1.0,
            value=current_temp,
            step=0.1,
            help="æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜ï¼Œå›ç­”è¶Šéšæœºï¼›å€¼è¶Šä½ï¼Œå›ç­”è¶Šç¡®å®šã€‚",
            key=f"{key_prefix}temperature_slider"
        )

        # æ˜¾ç¤ºæ¸©åº¦è§£é‡Š
        temp_explanation = self._get_temperature_explanation(temperature)
        st.caption(f"ğŸ’¡ {temp_explanation}")

        return temperature

    def render_rag_settings(self, current_top_k: int, current_search_type: str, key_prefix: str = "") -> tuple:
        """æ¸²æŸ“RAGè®¾ç½®"""
        """
        - ä½œç”¨ ï¼šé…ç½®æ£€ç´¢å¢å¼ºç”Ÿæˆå‚æ•°
        - ç•Œé¢å…ƒç´  ï¼šä¸¤ä¸ªæ»‘å—/é€‰æ‹©å™¨
        - è¿”å› ï¼štop_kå€¼å’Œæœç´¢ç±»å‹
        """
        st.subheader("ğŸ” RAGè®¾ç½®")

        col1, col2 = st.columns(2)

        with col1:
            top_k = st.slider(
                "æ£€ç´¢æ•°é‡ (Top-K)",
                min_value=1,
                max_value=10,
                value=current_top_k,
                step=1,
                help="ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢çš„ç›¸å…³æ–‡æ¡£æ•°é‡",
                key=f"{key_prefix}top_k_slider"
            )

        with col2:
            search_type = st.selectbox(
                "æœç´¢ç±»å‹",
                options=["similarity", "mmr"],
                index=0 if current_search_type == "similarity" else 1,
                help="similarity: ç›¸ä¼¼åº¦æœç´¢; mmr: æœ€å¤§è¾¹é™…ç›¸å…³æ€§æœç´¢",
                key=f"{key_prefix}search_type_select"
            )

        # æ˜¾ç¤ºæœç´¢ç±»å‹è§£é‡Š
        search_explanation = self._get_search_type_explanation(search_type)
        st.caption(f"ğŸ’¡ {search_explanation}")

        return top_k, search_type

    def render_vector_store_status(self, is_ready: bool, stats: Optional[Dict] = None):
        """æ¸²æŸ“å‘é‡å­˜å‚¨çŠ¶æ€"""
        """
        - ä½œç”¨ ï¼šæ˜¾ç¤ºçŸ¥è¯†åº“çŠ¶æ€
        - ç•Œé¢å…ƒç´  ï¼šçŠ¶æ€æŒ‡ç¤ºå™¨ + ç»Ÿè®¡ä¿¡æ¯
        """
        if is_ready:
            st.success("âœ… å‘é‡å­˜å‚¨å·²å‡†å¤‡å°±ç»ª")

            if stats:
                with st.expander("ğŸ“Š å‘é‡å­˜å‚¨ç»Ÿè®¡"):
                    col1, col2, col3 = st.columns(3)

                    with col1:
                        st.metric("æ–‡æ¡£æ•°é‡", stats.get('documents_count', 0))

                    with col2:
                        st.metric("å‘é‡æ€»æ•°", stats.get('total_vectors', 0))

                    with col3:
                        st.metric("å‘é‡ç»´åº¦", stats.get('dimension', 0))

                    if stats.get('index_path'):
                        st.caption(f"ğŸ“ ç´¢å¼•è·¯å¾„: {stats['index_path']}")

        else:
            st.warning("âš ï¸ å‘é‡å­˜å‚¨æœªå‡†å¤‡")

    def _get_temperature_explanation(self, temperature: float) -> str:
        """è·å–æ¸©åº¦ç³»æ•°è§£é‡Š"""
        if temperature < 0.3:
            return "ä½æ¸©åº¦ï¼šå›ç­”æ›´ç¡®å®šã€ä¿å®ˆ"
        elif temperature < 0.7:
            return "ä¸­ç­‰æ¸©åº¦ï¼šå¹³è¡¡ç¡®å®šæ€§å’Œåˆ›é€ æ€§"
        else:
            return "é«˜æ¸©åº¦ï¼šå›ç­”æ›´éšæœºã€æœ‰åˆ›é€ æ€§"

    def _get_search_type_explanation(self, search_type: str) -> str:
        """è·å–æœç´¢ç±»å‹è§£é‡Š"""
        if search_type == "similarity":
            return "ç›¸ä¼¼åº¦æœç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£"
        else:
            return "MMRæœç´¢ï¼šåœ¨ç›¸å…³æ€§å’Œå¤šæ ·æ€§ä¹‹é—´å–å¾—å¹³è¡¡"```

</details>

## æœ¬ç« æ€»ç»“

âœ… å®ç°äº†å¤©æ°”æŸ¥è¯¢æœåŠ¡
âœ… å®ç°äº†èŠå¤©å†å²ç®¡ç†å™¨
âœ… å®ç°äº†UIç»„ä»¶å°è£…

**ä¸‹èŠ‚é¢„å‘Š**ï¼šç¬¬07ç« å°†å®ç°æœ€æ ¸å¿ƒçš„Agentic RAG Agentã€‚
