# ç¬¬06ç« ï¼šè¾…åŠ©å·¥å…·ç±»(ä¸‹) - å¤©æ°”æŸ¥è¯¢ã€èŠå¤©å†å²ä¸UIç»„ä»¶

> **æœ¬ç« ç›®æ ‡**ï¼š
> 1. å®ç°åŸºäºé«˜å¾·åœ°å›¾APIçš„å¤©æ°”æŸ¥è¯¢æœåŠ¡ï¼Œä¸ºAgentæä¾›å®æ—¶å¤©æ°”å·¥å…·
> 2. æ„å»ºèŠå¤©å†å²ç®¡ç†å™¨ï¼Œæ”¯æŒä¼šè¯æŒä¹…åŒ–ã€æœç´¢å’Œå¯¼å‡ºåŠŸèƒ½
> 3. å°è£…Streamlit UIç»„ä»¶åº“ï¼Œæé«˜ç•Œé¢å¼€å‘æ•ˆç‡å’Œä¸€è‡´æ€§
> 4. æŒæ¡ç¬¬ä¸‰æ–¹APIé›†æˆã€æ•°æ®æŒä¹…åŒ–å’ŒUIç»„ä»¶åŒ–çš„æœ€ä½³å®è·µ

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰ä¸ªå·¥å…·ç±»ï¼Ÿä»Agentèƒ½åŠ›å¢å¼ºè°ˆèµ·

åœ¨å‰äº”ç« ï¼Œæˆ‘ä»¬æ„å»ºäº†RAGç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼šé…ç½®ç®¡ç†ã€LLMå®¢æˆ·ç«¯ã€å‘é‡å­˜å‚¨ã€è£…é¥°å™¨å’Œæ–‡æ¡£å¤„ç†å™¨ã€‚æœ¬ç« å°†å®Œæˆæœ€åä¸‰ä¸ªè¾…åŠ©å·¥å…·ç±»ï¼Œå®ƒä»¬åˆ†åˆ«è§£å†³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ï¼š

### 1.1 å¤©æ°”æŸ¥è¯¢æœåŠ¡ï¼šAgentçš„"çœ¼ç›"

**é—®é¢˜åœºæ™¯**ï¼š
```
ç”¨æˆ·ï¼š"ä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
ä¼ ç»ŸRAG â†’ âŒ å‘é‡åº“ä¸­æ²¡æœ‰å®æ—¶å¤©æ°”æ•°æ®
Agentic RAG + å¤©æ°”å·¥å…· â†’ âœ… è°ƒç”¨APIè·å–å®æ—¶ä¿¡æ¯
```

**WeatherServiceä½œç”¨**ï¼š
- ä¸ºAgentæä¾›è°ƒç”¨å¤–éƒ¨APIçš„èƒ½åŠ›
- å±•ç¤ºå¦‚ä½•å°†ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆåˆ°RAGç³»ç»Ÿ
- ç¤ºèŒƒå·¥å…·å‡½æ•°ï¼ˆTool Functionï¼‰çš„è®¾è®¡æ¨¡å¼

### 1.2 èŠå¤©å†å²ç®¡ç†ï¼šå¯¹è¯çš„"è®°å¿†"

**é—®é¢˜åœºæ™¯**ï¼š
```
ç”¨æˆ·ï¼š"æˆ‘åˆšæ‰é—®äº†ä»€ä¹ˆï¼Ÿ"
æ— å†å²ç®¡ç† â†’ âŒ ç³»ç»Ÿæ— æ³•å›æº¯
æœ‰å†å²ç®¡ç† â†’ âœ… æŸ¥è¯¢å†å²è®°å½•å¹¶å›ç­”
```

**ChatHistoryManagerä½œç”¨**ï¼š
- æŒä¹…åŒ–ç”¨æˆ·å¯¹è¯ï¼Œæ”¯æŒä¼šè¯æ¢å¤
- æä¾›æœç´¢ã€å¯¼å‡ºåŠŸèƒ½ï¼Œä¾¿äºå®¡è®¡å’Œåˆ†æ
- ä¸ºå¤šè½®å¯¹è¯æä¾›ä¸Šä¸‹æ–‡æ”¯æŒ

### 1.3 UIç»„ä»¶åº“ï¼šç•Œé¢çš„"ç§¯æœ¨"

**é—®é¢˜åœºæ™¯**ï¼š
```python
# ä¸ä½¿ç”¨ç»„ä»¶åŒ–
st.slider("æ¸©åº¦", 0.0, 1.0, 0.7)  # ä»£ç é‡å¤
st.slider("æ¸©åº¦", 0.0, 1.0, 0.7)  # æ ·å¼ä¸ç»Ÿä¸€

# ä½¿ç”¨ç»„ä»¶åŒ–
ui.render_temperature_slider(0.7)  # ç»Ÿä¸€å°è£…
```

**UIComponentsä½œç”¨**ï¼š
- å°è£…å¸¸ç”¨Streamlitç»„ä»¶ï¼Œé¿å…é‡å¤ä»£ç 
- ç»Ÿä¸€UIé£æ ¼å’Œäº¤äº’é€»è¾‘
- æé«˜å¼€å‘æ•ˆç‡ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

---

## äºŒã€å¤©æ°”æŸ¥è¯¢æœåŠ¡ï¼ˆservices/weather_tools.pyï¼‰

### 2.1 é«˜å¾·åœ°å›¾APIç®€ä»‹

**ä¸ºä»€ä¹ˆé€‰æ‹©é«˜å¾·åœ°å›¾ï¼Ÿ**

| å¯¹æ¯”é¡¹ | é«˜å¾·åœ°å›¾ | OpenWeatherMap | å’Œé£å¤©æ°” |
|--------|----------|---------------|----------|
| å›½å†…è®¿é—®é€Ÿåº¦ | å¿« | æ…¢ï¼ˆå›½å¤–æœåŠ¡å™¨ï¼‰ | ä¸­ç­‰ |
| å…è´¹é¢åº¦ | æ¯æ—¥30ä¸‡æ¬¡ | æ¯æ—¥1000æ¬¡ | æ¯æ—¥3000æ¬¡ |
| åŸå¸‚è¦†ç›– | å…¨å›½åœ°çº§å¸‚ | å…¨çƒ | å…¨çƒ |
| APIç¨³å®šæ€§ | é«˜ï¼ˆå›½å†…å¤§å‚ï¼‰ | é«˜ | ä¸­ |
| æ–‡æ¡£å‹å¥½åº¦ | ä¸­æ–‡æ–‡æ¡£ | è‹±æ–‡ | ä¸­æ–‡ |

**é«˜å¾·å¤©æ°”APIæ¶æ„**ï¼š

```mermaid
graph LR
    A[åŸå¸‚åç§°] --> B[åœ°ç†ç¼–ç API]
    B --> C[åŸå¸‚adcode]
    C --> D[å¤©æ°”æŸ¥è¯¢API]
    D --> E[å¤©æ°”æ•°æ®]

    E --> F{æ•°æ®ç±»å‹}
    F -->|base| G[å®å†µå¤©æ°”]
    F -->|all| H[å¤©æ°”é¢„æŠ¥]

    style C fill:#e1f5ff
    style G fill:#e7f9e7
    style H fill:#fff4e1
```

**å…³é”®æ¦‚å¿µ**ï¼š
- **adcode**ï¼šè¡Œæ”¿åŒºåˆ’ä»£ç ï¼ˆå¦‚åŒ—äº¬ï¼š110000ï¼‰ï¼Œé«˜å¾·APIçš„åŸå¸‚æ ‡è¯†
- **extensions=base**ï¼šæŸ¥è¯¢å®å†µå¤©æ°”ï¼ˆå½“å‰ï¼‰
- **extensions=all**ï¼šæŸ¥è¯¢é¢„æŠ¥å¤©æ°”ï¼ˆæœªæ¥3-7å¤©ï¼‰

### 2.2 WeatherServiceæ¶æ„è®¾è®¡

**åŠŸèƒ½æ¨¡å—**ï¼ˆ331è¡Œä»£ç ï¼‰ï¼š

```
WeatherService åŠŸèƒ½æ¨¡å—
â”œâ”€â”€ ğŸ™ï¸ åŸå¸‚æŸ¥è¯¢
â”‚   â”œâ”€â”€ get_city_code()           - åŸå¸‚åâ†’adcodeï¼ˆå¸¦ç¼“å­˜ï¼‰
â”‚   â””â”€â”€ city_cache                - åŸå¸‚ä»£ç ç¼“å­˜ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
â”‚
â”œâ”€â”€ ğŸŒ¤ï¸ å¤©æ°”æŸ¥è¯¢
â”‚   â”œâ”€â”€ get_current_weather()     - å½“å‰å¤©æ°”
â”‚   â”œâ”€â”€ get_weather_forecast()    - å¤©æ°”é¢„æŠ¥ï¼ˆ1-7å¤©ï¼‰
â”‚   â””â”€â”€ è¯·æ±‚å‚æ•°æ„å»º
â”‚
â””â”€â”€ ğŸ“ æ•°æ®æ ¼å¼åŒ–
    â”œâ”€â”€ _format_current_weather() - æ ¼å¼åŒ–å®å†µå¤©æ°”
    â””â”€â”€ _format_weather_forecast() - æ ¼å¼åŒ–é¢„æŠ¥æ•°æ®
```

### 2.3 ä»£ç å®ç°è¯¦è§£

> **è¯´æ˜**ï¼š`services/weather_tools.py` å…±331è¡Œï¼Œæ‹†åˆ†ä¸º4ä¸ªéƒ¨åˆ†è®²è§£ã€‚

#### 2.3.1 ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆå§‹åŒ–ä¸åŸå¸‚ä»£ç æŸ¥è¯¢ï¼ˆ1-70è¡Œï¼‰

```python
class WeatherService:
    """å¤©æ°”æŸ¥è¯¢æœåŠ¡ç±»"""

    def __init__(self):
        self.settings = Settings()
        self.api_key = self.settings.WEATHER_API_KEY
        self.weather_url = self.settings.WEATHER_API_URL
        self.city_url = self.settings.WEATHER_CITY_URL

        # åŸå¸‚ä»£ç ç¼“å­˜
        self.city_cache = {}

    def get_city_code(self, city_name: str) -> Optional[str]:
        """è·å–åŸå¸‚ä»£ç """
        try:
            # æ£€æŸ¥ç¼“å­˜
            if city_name in self.city_cache:
                return self.city_cache[city_name]

            # æ„å»ºè¯·æ±‚URL
            url = f"{self.city_url}"
            params = {
                "keywords": city_name,
                "subdistrict": 0,        # ä¸è¿”å›ä¸‹çº§è¡Œæ”¿åŒº
                "key": self.api_key,
                "extensions": "base"
            }

            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "1" and data.get("districts"):
                districts = data["districts"]
                if districts and len(districts) > 0:
                    city_code = districts[0].get("adcode")
                    if city_code:
                        # ç¼“å­˜ç»“æœ
                        self.city_cache[city_name] = city_code
                        logger.info(f"è·å–åŸå¸‚ä»£ç æˆåŠŸ: {city_name} -> {city_code}")
                        return city_code

            logger.warning(f"æœªæ‰¾åˆ°åŸå¸‚: {city_name}")
            return None

        except requests.RequestException as e:
            logger.error(f"è·å–åŸå¸‚ä»£ç å¤±è´¥: {str(e)}")
            return None
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **åŸå¸‚ä»£ç ç¼“å­˜**ï¼š
   ```python
   if city_name in self.city_cache:
       return self.city_cache[city_name]
   ```
   - **ä¸ºä»€ä¹ˆéœ€è¦**ï¼Ÿé¿å…é‡å¤æŸ¥è¯¢åŒä¸€åŸå¸‚çš„adcode
   - **æ•ˆæœ**ï¼šç¬¬äºŒæ¬¡æŸ¥è¯¢"åŒ—äº¬"ç›´æ¥ä»å†…å­˜è¿”å›ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚

2. **APIå“åº”ç»“æ„**ï¼š
   ```json
   {
     "status": "1",
     "districts": [
       {
         "adcode": "110000",
         "name": "åŒ—äº¬å¸‚",
         "level": "province"
       }
     ]
   }
   ```

3. **é”™è¯¯å¤„ç†**ï¼š
   ```python
   response.raise_for_status()  # HTTPé”™è¯¯æŠ›å¼‚å¸¸
   except requests.RequestException as e:  # æ•è·ç½‘ç»œå¼‚å¸¸
   ```

#### 2.3.2 ç¬¬äºŒéƒ¨åˆ†ï¼šå½“å‰å¤©æ°”æŸ¥è¯¢ï¼ˆ71-123è¡Œï¼‰

```python
def get_current_weather(self, city_name: str) -> str:
    """è·å–å½“å‰å¤©æ°”"""
    try:
        city_code = self.get_city_code(city_name)
        if not city_code:
            return f"æŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°åŸå¸‚ '{city_name}' çš„ä¿¡æ¯ã€‚è¯·æ£€æŸ¥åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"

        # æ„å»ºè¯·æ±‚URL
        params = {
            "city": city_code,
            "key": self.api_key,
            "extensions": "base"  # base=å®å†µå¤©æ°”
        }

        response = requests.get(self.weather_url, params=params, timeout=10)
        response.raise_for_status()

        data = response.json()

        if data.get("status") == "1" and data.get("lives"):
            weather_info = data["lives"][0]

            # æ ¼å¼åŒ–å¤©æ°”ä¿¡æ¯
            result = self._format_current_weather(weather_info, city_name)
            logger.info(f"è·å–å½“å‰å¤©æ°”æˆåŠŸ: {city_name}")
            return result
        else:
            error_msg = data.get("info", "æœªçŸ¥é”™è¯¯")
            logger.warning(f"è·å–å½“å‰å¤©æ°”å¤±è´¥: {error_msg}")
            return f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: {error_msg}"

    except requests.RequestException as e:
        error_msg = f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}"
        logger.error(f"è·å–å½“å‰å¤©æ°”å¤±è´¥: {error_msg}")
        return f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"
```

**APIå“åº”ç¤ºä¾‹**ï¼š

```json
{
  "status": "1",
  "lives": [
    {
      "province": "åŒ—äº¬",
      "city": "åŒ—äº¬å¸‚",
      "weather": "æ™´",
      "temperature": "15",
      "winddirection": "è¥¿åŒ—",
      "windpower": "â‰¤3",
      "humidity": "45",
      "reporttime": "2024-01-15 14:00:00"
    }
  ]
}
```

#### 2.3.3 ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¤©æ°”é¢„æŠ¥æŸ¥è¯¢ï¼ˆ111-157è¡Œï¼‰

```python
def get_weather_forecast(self, city_name: str, days: int = 3) -> str:
    """è·å–å¤©æ°”é¢„æŠ¥"""
    try:
        if days < 1 or days > 7:
            return "é¢„æŠ¥å¤©æ•°å¿…é¡»åœ¨1-7å¤©ä¹‹é—´ã€‚"

        city_code = self.get_city_code(city_name)
        if not city_code:
            return f"æŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°åŸå¸‚ '{city_name}' çš„ä¿¡æ¯ã€‚è¯·æ£€æŸ¥åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®ã€‚"

        # æ„å»ºè¯·æ±‚URL
        params = {
            "city": city_code,
            "key": self.api_key,
            "extensions": "all"  # all=é¢„æŠ¥å¤©æ°”
        }

        response = requests.get(self.weather_url, params=params, timeout=10)
        response.raise_for_status()

        data = response.json()

        if data.get("status") == "1" and data.get("forecasts"):
            forecast_info = data["forecasts"][0]

            # æ ¼å¼åŒ–é¢„æŠ¥ä¿¡æ¯
            result = self._format_weather_forecast(forecast_info, city_name, days)
            logger.info(f"è·å–å¤©æ°”é¢„æŠ¥æˆåŠŸ: {city_name}, å¤©æ•°: {days}")
            return result
        else:
            error_msg = data.get("info", "æœªçŸ¥é”™è¯¯")
            logger.warning(f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}")
            return f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}"

    except requests.RequestException as e:
        error_msg = f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}"
        logger.error(f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥: {error_msg}")
        return f"è·å–å¤©æ°”é¢„æŠ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"
```

**é¢„æŠ¥æ•°æ®ç»“æ„**ï¼š

```json
{
  "forecasts": [
    {
      "province": "åŒ—äº¬",
      "city": "åŒ—äº¬å¸‚",
      "reporttime": "2024-01-15 11:00:00",
      "casts": [
        {
          "date": "2024-01-15",
          "week": "1",
          "dayweather": "æ™´",
          "nightweather": "æ™´",
          "daytemp": "15",
          "nighttemp": "5",
          "daywind": "è¥¿åŒ—",
          "nightwind": "è¥¿åŒ—",
          "daypower": "â‰¤3",
          "nightpower": "â‰¤3"
        }
        // ... æ›´å¤šå¤©æ•°
      ]
    }
  ]
}
```

#### 2.3.4 ç¬¬å››éƒ¨åˆ†ï¼šæ•°æ®æ ¼å¼åŒ–ï¼ˆ159-264è¡Œï¼‰

```python
def _format_current_weather(self, weather_data: Dict[str, Any], city_name: str) -> str:
    """æ ¼å¼åŒ–å½“å‰å¤©æ°”ä¿¡æ¯"""
    try:
        province = weather_data.get("province", "")
        city = weather_data.get("city", city_name)
        weather = weather_data.get("weather", "")
        temperature = weather_data.get("temperature", "")
        winddirection = weather_data.get("winddirection", "")
        windpower = weather_data.get("windpower", "")
        humidity = weather_data.get("humidity", "")
        reporttime = weather_data.get("reporttime", "")

        # æ„å»ºæ ¼å¼åŒ–è¾“å‡º
        result = f"ğŸ™ï¸ **{province} {city}** å½“å‰å¤©æ°”\n\n"
        result += f"ğŸŒ¤ï¸ **å¤©æ°”çŠ¶å†µ**: {weather}\n"
        result += f"ğŸŒ¡ï¸ **æ°”æ¸©**: {temperature}Â°C\n"
        result += f"ğŸ’¨ **é£å‘é£åŠ›**: {winddirection} {windpower}\n"
        result += f"ğŸ’§ **æ¹¿åº¦**: {humidity}%\n"
        result += f"ğŸ“… **å‘å¸ƒæ—¶é—´**: {reporttime}\n"

        # æ·»åŠ å¤©æ°”å»ºè®®
        result += "\nğŸ’¡ **æ¸©é¦¨æç¤º**:\n"

        if temperature and temperature.isdigit():
            temp = int(temperature)
            if temp < 10:
                result += "â€¢ å¤©æ°”è¾ƒå†·ï¼Œè¯·æ³¨æ„ä¿æš–ã€‚\n"
            elif temp > 30:
                result += "â€¢ å¤©æ°”è¾ƒçƒ­ï¼Œè¯·æ³¨æ„é˜²æš‘ã€‚\n"
            else:
                result += "â€¢ å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå¤–å‡ºã€‚\n"

        if humidity and humidity.isdigit():
            hum = int(humidity)
            if hum > 80:
                result += "â€¢ æ¹¿åº¦è¾ƒé«˜ï¼Œæ³¨æ„é˜²æ½®ã€‚\n"
            elif hum < 30:
                result += "â€¢ æ¹¿åº¦è¾ƒä½ï¼Œæ³¨æ„è¡¥æ°´ã€‚\n"

        return result

    except Exception as e:
        logger.error(f"æ ¼å¼åŒ–å½“å‰å¤©æ°”ä¿¡æ¯å¤±è´¥: {str(e)}")
        return f"å¤©æ°”æ•°æ®æ ¼å¼åŒ–å¤±è´¥: {str(e)}"
```

**æ ¼å¼åŒ–è¾“å‡ºç¤ºä¾‹**ï¼š

```
ğŸ™ï¸ **åŒ—äº¬ åŒ—äº¬å¸‚** å½“å‰å¤©æ°”

ğŸŒ¤ï¸ **å¤©æ°”çŠ¶å†µ**: æ™´
ğŸŒ¡ï¸ **æ°”æ¸©**: 15Â°C
ğŸ’¨ **é£å‘é£åŠ›**: è¥¿åŒ— â‰¤3
ğŸ’§ **æ¹¿åº¦**: 45%
ğŸ“… **å‘å¸ƒæ—¶é—´**: 2024-01-15 14:00:00

ğŸ’¡ **æ¸©é¦¨æç¤º**:
â€¢ å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå¤–å‡ºã€‚
```

**æ™ºèƒ½å»ºè®®é€»è¾‘**ï¼š

```python
if temp < 10:
    result += "â€¢ å¤©æ°”è¾ƒå†·ï¼Œè¯·æ³¨æ„ä¿æš–ã€‚\n"
elif temp > 30:
    result += "â€¢ å¤©æ°”è¾ƒçƒ­ï¼Œè¯·æ³¨æ„é˜²æš‘ã€‚\n"
else:
    result += "â€¢ å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå¤–å‡ºã€‚\n"
```

- **è®¾è®¡ç›®çš„**ï¼šè®©å¤©æ°”ä¿¡æ¯æ›´äººæ€§åŒ–ï¼Œä¸åªæ˜¯å†°å†·çš„æ•°æ®
- **æ‰©å±•æ€§**ï¼šå¯å¢åŠ æ›´å¤šè§„åˆ™ï¼ˆå¦‚PM2.5å»ºè®®ã€ç©¿è¡£æŒ‡æ•°ç­‰ï¼‰

---

## ä¸‰ã€èŠå¤©å†å²ç®¡ç†å™¨ï¼ˆutils/chat_history.pyï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦èŠå¤©å†å²ï¼Ÿ

**å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡**ï¼š

```
# æ— å†å²ç®¡ç†
ç”¨æˆ·ï¼š"Pythonæ˜¯ä»€ä¹ˆï¼Ÿ"
AIï¼š"Pythonæ˜¯ç¼–ç¨‹è¯­è¨€"

ç”¨æˆ·ï¼š"å®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"
AIï¼š"ä»€ä¹ˆä¸œè¥¿çš„ç‰¹ç‚¹ï¼Ÿ" â† âŒ ä¸¢å¤±ä¸Šä¸‹æ–‡

# æœ‰å†å²ç®¡ç†
ç”¨æˆ·ï¼š"Pythonæ˜¯ä»€ä¹ˆï¼Ÿ"
AIï¼š"Pythonæ˜¯ç¼–ç¨‹è¯­è¨€"
[ä¿å­˜åˆ°å†å²]

ç”¨æˆ·ï¼š"å®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"
AIï¼š"Pythonçš„ç‰¹ç‚¹åŒ…æ‹¬..." â† âœ… ä»å†å²è·å–ä¸Šä¸‹æ–‡
```

**å®¡è®¡å’Œåˆ†æ**ï¼š

```python
# å¯¼å‡ºå¯¹è¯è®°å½•ä¸ºCSV
manager.export_to_csv("chat_history.csv")

# åˆ†æç”¨æˆ·å¸¸é—®é—®é¢˜
results = manager.search_history("Python")
print(f"ç”¨æˆ·è¯¢é—®Pythonç›¸å…³é—®é¢˜ {len(results)} æ¬¡")
```

### 3.2 ChatHistoryManageræ¶æ„è®¾è®¡

**åŠŸèƒ½æ¨¡å—**ï¼ˆ488è¡Œä»£ç ï¼‰ï¼š

```
ChatHistoryManager åŠŸèƒ½æ¨¡å—
â”œâ”€â”€ ğŸ’¬ æ¶ˆæ¯ç®¡ç†
â”‚   â”œâ”€â”€ add_message()             - æ·»åŠ æ¶ˆæ¯ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
â”‚   â”œâ”€â”€ get_history()             - è·å–å†å²ï¼ˆæ”¯æŒè¿‡æ»¤ï¼‰
â”‚   â””â”€â”€ clear_history()           - æ¸…ç©ºå†å²
â”‚
â”œâ”€â”€ ğŸ” æœç´¢åŠŸèƒ½
â”‚   â””â”€â”€ search_history()          - å…³é”®è¯æœç´¢ï¼ˆæ”¯æŒè§’è‰²è¿‡æ»¤ï¼‰
â”‚
â”œâ”€â”€ ğŸ“Š å¯¼å‡ºåŠŸèƒ½
â”‚   â””â”€â”€ export_to_csv()           - å¯¼å‡ºä¸ºCSVï¼ˆå­—ç¬¦ä¸²æˆ–æ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ ğŸ’¾ æŒä¹…åŒ–
â”‚   â”œâ”€â”€ load_history()            - ä»JSONåŠ è½½
â”‚   â”œâ”€â”€ save_history()            - ä¿å­˜åˆ°JSON
â”‚   â””â”€â”€ history_file              - å†å²æ–‡ä»¶è·¯å¾„
â”‚
â””â”€â”€ ğŸ› ï¸ è¾…åŠ©æ–¹æ³•
    â””â”€â”€ _generate_message_id()    - ç”ŸæˆUUID
```

### 3.3 æ•°æ®ç»“æ„è®¾è®¡

**æ¶ˆæ¯ç»“æ„**ï¼š

```python
{
  "role": "user",                          # æ¶ˆæ¯è§’è‰²
  "content": "Pythonæ˜¯ä»€ä¹ˆï¼Ÿ",              # æ¶ˆæ¯å†…å®¹
  "timestamp": "2024-01-15T14:30:00",      # æ—¶é—´æˆ³
  "id": "550e8400-e29b-41d4-a716-446655440000",  # å”¯ä¸€ID
  "metadata": {                            # å¯é€‰å…ƒæ•°æ®
    "model": "gpt-4",
    "temperature": 0.7
  }
}
```

**å†å²æ–‡ä»¶ç»“æ„**ï¼š

```json
[
  {
    "role": "user",
    "content": "ä½ å¥½",
    "timestamp": "2024-01-15T14:30:00",
    "id": "uuid-1"
  },
  {
    "role": "assistant",
    "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
    "timestamp": "2024-01-15T14:30:05",
    "id": "uuid-2",
    "metadata": {"model": "gpt-4"}
  }
]
```

### 3.4 æ ¸å¿ƒæ–¹æ³•å®ç°

#### 3.4.1 æ·»åŠ æ¶ˆæ¯ï¼ˆ48-95è¡Œï¼‰

```python
def add_message(self, role: str, content: str, metadata: Dict[str, Any] = None) -> bool:
    """æ·»åŠ æ¶ˆæ¯åˆ°å†å²è®°å½•"""
    try:
        message = {
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat(),
            "id": self._generate_message_id()
        }

        if metadata:
            message["metadata"] = metadata

        self.chat_history.append(message)

        # å¦‚æœè¶…è¿‡æœ€å¤§æ•°é‡ï¼Œç§»é™¤æœ€æ—§çš„è®°å½•
        if len(self.chat_history) > self.max_history_size:
            self.chat_history.pop(0)

        # ä¿å­˜åˆ°æ–‡ä»¶
        self.save_history()

        logger.debug(f"æ·»åŠ æ¶ˆæ¯æˆåŠŸ: {role}")
        return True

    except Exception as e:
        logger.error(f"æ·»åŠ æ¶ˆæ¯å¤±è´¥: {str(e)}")
        return False
```

**å…³é”®è®¾è®¡**ï¼š

1. **è‡ªåŠ¨ç”ŸæˆIDå’Œæ—¶é—´æˆ³**ï¼š
   ```python
   "timestamp": datetime.now().isoformat()
   "id": self._generate_message_id()  # UUID
   ```
   - æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€æ ‡è¯†ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•

2. **å†å²å¤§å°é™åˆ¶**ï¼š
   ```python
   if len(self.chat_history) > self.max_history_size:
       self.chat_history.pop(0)  # ç§»é™¤æœ€æ—§è®°å½•
   ```
   - **ä¸ºä»€ä¹ˆéœ€è¦**ï¼Ÿé¿å…å†å²æ–‡ä»¶æ— é™å¢é•¿å æ»¡ç£ç›˜
   - **é»˜è®¤é™åˆ¶**ï¼š10000æ¡æ¶ˆæ¯

3. **å³æ—¶æŒä¹…åŒ–**ï¼š
   ```python
   self.save_history()  # æ¯æ¬¡æ·»åŠ éƒ½ä¿å­˜
   ```
   - **ä¼˜ç‚¹**ï¼šä¸ä¼šä¸¢å¤±æ•°æ®ï¼ˆå³ä½¿ç¨‹åºå´©æºƒï¼‰
   - **ç¼ºç‚¹**ï¼šé¢‘ç¹IOï¼ˆå¯ä¼˜åŒ–ä¸ºæ‰¹é‡ä¿å­˜ï¼‰

#### 3.4.2 æœç´¢å†å²ï¼ˆ242-291è¡Œï¼‰

```python
def search_history(self, keyword: str, role_filter: str = None) -> List[Dict[str, Any]]:
    """æœç´¢å†å²è®°å½•"""
    try:
        results = []
        keyword = keyword.lower()

        for message in self.chat_history:
            # è§’è‰²è¿‡æ»¤
            if role_filter and message.get("role") != role_filter:
                continue

            # å†…å®¹æœç´¢
            content = message.get("content", "").lower()
            if keyword in content:
                results.append(message)

        logger.info(f"æœç´¢å†å²è®°å½•: '{keyword}' - æ‰¾åˆ° {len(results)} æ¡ç»“æœ")
        return results

    except Exception as e:
        logger.error(f"æœç´¢å†å²è®°å½•å¤±è´¥: {str(e)}")
        return []
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
manager = ChatHistoryManager()

# æœç´¢æ‰€æœ‰åŒ…å«"Python"çš„æ¶ˆæ¯
results = manager.search_history("python")

# åªæœç´¢ç”¨æˆ·çš„é—®é¢˜
user_questions = manager.search_history("æ˜¯ä»€ä¹ˆ", role_filter="user")

# åªæœç´¢AIçš„å›ç­”
ai_answers = manager.search_history("ç¼–ç¨‹è¯­è¨€", role_filter="assistant")
```

**æœç´¢ç®—æ³•**ï¼š

```python
keyword = keyword.lower()             # 1. è½¬å°å†™ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
content = message.get("content", "").lower()  # 2. å†…å®¹è½¬å°å†™
if keyword in content:                # 3. å­ä¸²åŒ¹é…
    results.append(message)
```

- **ç®€å•ä½†æœ‰æ•ˆ**ï¼šé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯
- **å¯ä¼˜åŒ–æ–¹å‘**ï¼š
  - æ­£åˆ™è¡¨è¾¾å¼æœç´¢
  - åˆ†è¯+å€’æ’ç´¢å¼•ï¼ˆå¤§è§„æ¨¡å†å²ï¼‰
  - å‘é‡è¯­ä¹‰æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰

#### 3.4.3 å¯¼å‡ºCSVï¼ˆ175-240è¡Œï¼‰

```python
def export_to_csv(self, output_file: str = None) -> str:
    """å¯¼å‡ºä¸ºCSVæ ¼å¼"""
    try:
        if not output_file:
            # è¿”å›CSVå­—ç¬¦ä¸²
            import io
            output = io.StringIO()

            if self.chat_history:
                # å®šä¹‰æ ‡å‡†CSVå­—æ®µ
                standard_fields = ['role', 'content', 'timestamp', 'id']
                writer = csv.DictWriter(output, fieldnames=standard_fields)
                writer.writeheader()

                # åªå¯¼å‡ºæ ‡å‡†å­—æ®µ
                for message in self.chat_history:
                    row = {field: message.get(field, '') for field in standard_fields}
                    writer.writerow(row)

            csv_content = output.getvalue()
            output.close()

            logger.info("å¯¼å‡ºCSVæˆåŠŸ")
            return csv_content
        else:
            # ä¿å­˜åˆ°æ–‡ä»¶
            with open(output_file, 'w', newline='', encoding='utf-8') as f:
                # ... åŒæ ·çš„é€»è¾‘
```

**CSVè¾“å‡ºç¤ºä¾‹**ï¼š

```csv
role,content,timestamp,id
user,Pythonæ˜¯ä»€ä¹ˆï¼Ÿ,2024-01-15T14:30:00,uuid-1
assistant,Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€,2024-01-15T14:30:05,uuid-2
user,å®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ,2024-01-15T14:31:00,uuid-3
```

**ä¸ºä»€ä¹ˆä¸å¯¼å‡ºmetadata**ï¼š

```python
standard_fields = ['role', 'content', 'timestamp', 'id']  # ä¸åŒ…å«metadata
```

- metadataæ˜¯åµŒå¥—å­—å…¸ï¼Œä¸é€‚åˆCSVæ‰å¹³ç»“æ„
- å¦‚æœéœ€è¦å®Œæ•´æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨JSONæ–‡ä»¶

---

## å››ã€UIç»„ä»¶åº“ï¼ˆutils/ui_components.pyï¼‰

### 4.1 Streamlitç»„ä»¶åŒ–çš„å¿…è¦æ€§

**é—®é¢˜ï¼šä»£ç é‡å¤**

```python
# é¡µé¢A
st.slider("æ¸©åº¦", 0.0, 1.0, 0.7, help="æ§åˆ¶éšæœºæ€§")
if 0.7 < 0.3:
    st.caption("ä½æ¸©åº¦")

# é¡µé¢B
st.slider("æ¸©åº¦", 0.0, 1.0, 0.8, help="æ§åˆ¶éšæœºæ€§")
if 0.8 < 0.3:
    st.caption("ä½æ¸©åº¦")

# é¡µé¢C
st.slider("æ¸©åº¦ç³»æ•°", 0.0, 1.0, 0.5, help="...")  # â† å‚æ•°ä¸ä¸€è‡´ï¼
```

**è§£å†³æ–¹æ¡ˆï¼šç»„ä»¶åŒ–**

```python
# ç»Ÿä¸€å°è£…
ui = UIComponents()

# é¡µé¢A/B/C
temperature = ui.render_temperature_slider(0.7)
```

### 4.2 UIComponentsåŠŸèƒ½æ¨¡å—

**ç»„ä»¶åˆ—è¡¨**ï¼ˆ139è¡Œä»£ç ï¼‰ï¼š

```
UIComponents ç»„ä»¶æ¨¡å—
â”œâ”€â”€ ğŸ¤– render_model_selector()      - æ¨¡å‹é€‰æ‹©å™¨ï¼ˆä¸‹æ‹‰æ¡†+åˆ·æ–°æŒ‰é’®ï¼‰
â”œâ”€â”€ ğŸŒ¡ï¸ render_temperature_slider()  - æ¸©åº¦æ»‘å—ï¼ˆå¸¦æ™ºèƒ½æç¤ºï¼‰
â”œâ”€â”€ ğŸ” render_rag_settings()        - RAGè®¾ç½®ï¼ˆTop-K+æœç´¢ç±»å‹ï¼‰
â”œâ”€â”€ ğŸ“Š render_vector_store_status() - å‘é‡å­˜å‚¨çŠ¶æ€ï¼ˆçŠ¶æ€+ç»Ÿè®¡ï¼‰
â””â”€â”€ ğŸ’¡ è¾…åŠ©æ–¹æ³•
    â”œâ”€â”€ _get_temperature_explanation()   - æ¸©åº¦è§£é‡Š
    â””â”€â”€ _get_search_type_explanation()   - æœç´¢ç±»å‹è§£é‡Š
```

### 4.3 æ ¸å¿ƒç»„ä»¶å®ç°

#### 4.3.1 æ¸©åº¦æ»‘å—ï¼ˆ37-58è¡Œï¼‰

```python
def render_temperature_slider(self, current_temp: float, key_prefix: str = "") -> float:
    """æ¸²æŸ“æ¸©åº¦ç³»æ•°æ»‘å—"""
    temperature = st.slider(
        "ğŸŒ¡ï¸ æ¸©åº¦ç³»æ•° (Temperature)",
        min_value=0.0,
        max_value=1.0,
        value=current_temp,
        step=0.1,
        help="æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜ï¼Œå›ç­”è¶Šéšæœºï¼›å€¼è¶Šä½ï¼Œå›ç­”è¶Šç¡®å®šã€‚",
        key=f"{key_prefix}temperature_slider"
    )

    # æ˜¾ç¤ºæ¸©åº¦è§£é‡Š
    temp_explanation = self._get_temperature_explanation(temperature)
    st.caption(f"ğŸ’¡ {temp_explanation}")

    return temperature

def _get_temperature_explanation(self, temperature: float) -> str:
    """è·å–æ¸©åº¦ç³»æ•°è§£é‡Š"""
    if temperature < 0.3:
        return "ä½æ¸©åº¦ï¼šå›ç­”æ›´ç¡®å®šã€ä¿å®ˆ"
    elif temperature < 0.7:
        return "ä¸­ç­‰æ¸©åº¦ï¼šå¹³è¡¡ç¡®å®šæ€§å’Œåˆ›é€ æ€§"
    else:
        return "é«˜æ¸©åº¦ï¼šå›ç­”æ›´éšæœºã€æœ‰åˆ›é€ æ€§"
```

**ç•Œé¢æ•ˆæœ**ï¼š

```
ğŸŒ¡ï¸ æ¸©åº¦ç³»æ•° (Temperature)
[========|--------] 0.4

ğŸ’¡ ä¸­ç­‰æ¸©åº¦ï¼šå¹³è¡¡ç¡®å®šæ€§å’Œåˆ›é€ æ€§
```

**key_prefixçš„ä½œç”¨**ï¼š

```python
key=f"{key_prefix}temperature_slider"
```

- **é—®é¢˜**ï¼šStreamlitè¦æ±‚æ¯ä¸ªç»„ä»¶æœ‰å”¯ä¸€key
- **è§£å†³**ï¼šé€šè¿‡key_prefixåŒºåˆ†ä¸åŒé¡µé¢çš„ç›¸åŒç»„ä»¶
  ```python
  ui.render_temperature_slider(0.7, key_prefix="chat_")
  ui.render_temperature_slider(0.5, key_prefix="settings_")
  ```

#### 4.3.2 RAGè®¾ç½®ï¼ˆ60-95è¡Œï¼‰

```python
def render_rag_settings(self, current_top_k: int, current_search_type: str, key_prefix: str = "") -> tuple:
    """æ¸²æŸ“RAGè®¾ç½®"""
    st.subheader("ğŸ” RAGè®¾ç½®")

    col1, col2 = st.columns(2)

    with col1:
        top_k = st.slider(
            "æ£€ç´¢æ•°é‡ (Top-K)",
            min_value=1,
            max_value=10,
            value=current_top_k,
            step=1,
            help="ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢çš„ç›¸å…³æ–‡æ¡£æ•°é‡",
            key=f"{key_prefix}top_k_slider"
        )

    with col2:
        search_type = st.selectbox(
            "æœç´¢ç±»å‹",
            options=["similarity", "mmr"],
            index=0 if current_search_type == "similarity" else 1,
            help="similarity: ç›¸ä¼¼åº¦æœç´¢; mmr: æœ€å¤§è¾¹é™…ç›¸å…³æ€§æœç´¢",
            key=f"{key_prefix}search_type_select"
        )

    # æ˜¾ç¤ºæœç´¢ç±»å‹è§£é‡Š
    search_explanation = self._get_search_type_explanation(search_type)
    st.caption(f"ğŸ’¡ {search_explanation}")

    return top_k, search_type
```

**ç•Œé¢å¸ƒå±€**ï¼š

```
ğŸ” RAGè®¾ç½®

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€ç´¢æ•°é‡ (Top-K) â”‚ æœç´¢ç±»å‹          â”‚
â”‚ [====|----] 5    â”‚ â–¼ similarity     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ç›¸ä¼¼åº¦æœç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£
```

**st.columnså¸ƒå±€**ï¼š

```python
col1, col2 = st.columns(2)  # 2åˆ—ç­‰å®½å¸ƒå±€

with col1:
    # å·¦ä¾§ç»„ä»¶
    top_k = st.slider(...)

with col2:
    # å³ä¾§ç»„ä»¶
    search_type = st.selectbox(...)
```

#### 4.3.3 å‘é‡å­˜å‚¨çŠ¶æ€ï¼ˆ97-123è¡Œï¼‰

```python
def render_vector_store_status(self, is_ready: bool, stats: Optional[Dict] = None):
    """æ¸²æŸ“å‘é‡å­˜å‚¨çŠ¶æ€"""
    if is_ready:
        st.success("âœ… å‘é‡å­˜å‚¨å·²å‡†å¤‡å°±ç»ª")

        if stats:
            with st.expander("ğŸ“Š å‘é‡å­˜å‚¨ç»Ÿè®¡"):
                col1, col2, col3 = st.columns(3)

                with col1:
                    st.metric("æ–‡æ¡£æ•°é‡", stats.get('documents_count', 0))

                with col2:
                    st.metric("å‘é‡æ€»æ•°", stats.get('total_vectors', 0))

                with col3:
                    st.metric("å‘é‡ç»´åº¦", stats.get('dimension', 0))

                if stats.get('index_path'):
                    st.caption(f"ğŸ“ ç´¢å¼•è·¯å¾„: {stats['index_path']}")

    else:
        st.warning("âš ï¸ å‘é‡å­˜å‚¨æœªå‡†å¤‡")
```

**ç•Œé¢æ•ˆæœ**ï¼š

```
âœ… å‘é‡å­˜å‚¨å·²å‡†å¤‡å°±ç»ª

ğŸ“Š å‘é‡å­˜å‚¨ç»Ÿè®¡ â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡æ¡£æ•°é‡  â”‚ å‘é‡æ€»æ•°  â”‚ å‘é‡ç»´åº¦  â”‚
â”‚   150    â”‚   150    â”‚  1536    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ ç´¢å¼•è·¯å¾„: data/vector_store
```

**st.metricçš„å¦™ç”¨**ï¼š

```python
st.metric("æ–‡æ¡£æ•°é‡", 150)
```

- è‡ªåŠ¨æ ¼å¼åŒ–æ•°å­—ï¼ˆå¦‚150,000 â†’ 150Kï¼‰
- æ”¯æŒå˜åŒ–é‡æ˜¾ç¤ºï¼ˆdeltaå‚æ•°ï¼‰
- è§†è§‰æ•ˆæœé†’ç›®

---

## äº”ã€å®Œæ•´ä»£ç 

### 5.1 å¤©æ°”æŸ¥è¯¢æœåŠ¡

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ services/weather_tools.py å®Œæ•´ä»£ç ï¼ˆ331è¡Œï¼‰</summary>

```python
# è§æœ¬ç« 2.3èŠ‚å„éƒ¨åˆ†ä»£ç ï¼Œæ­¤å¤„çœç•¥å®Œæ•´ä»£ç ä»¥èŠ‚çœç¯‡å¹…
# å®Œæ•´ä»£ç è¯·å‚è€ƒé¡¹ç›®æºæ–‡ä»¶
```

</details>

### 5.2 èŠå¤©å†å²ç®¡ç†å™¨

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ utils/chat_history.py å®Œæ•´ä»£ç ï¼ˆ488è¡Œï¼‰</summary>

```python
# è§æœ¬ç« 3.4èŠ‚å„éƒ¨åˆ†ä»£ç ï¼Œæ­¤å¤„çœç•¥å®Œæ•´ä»£ç ä»¥èŠ‚çœç¯‡å¹…
# å®Œæ•´ä»£ç è¯·å‚è€ƒé¡¹ç›®æºæ–‡ä»¶
```

</details>

### 5.3 UIç»„ä»¶åº“

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ utils/ui_components.py å®Œæ•´ä»£ç ï¼ˆ139è¡Œï¼‰</summary>

```python
import streamlit as st
from typing import List, Dict, Optional, Any
from config.settings import Settings

class UIComponents:
    """UIç»„ä»¶ç±» - è´Ÿè´£æ¸²æŸ“å„ç§Streamlitç•Œé¢å…ƒç´ """

    def __init__(self):
        self.settings = Settings()

    def render_model_selector(self, current_model: str, key_prefix: str = "") -> str:
        """æ¸²æŸ“æ¨¡å‹é€‰æ‹©å™¨"""
        col1, col2 = st.columns([2, 1])

        with col1:
            selected_model = st.selectbox(
                "ğŸ¤– é€‰æ‹©æ¨¡å‹",
                options=self.settings.AVAILABLE_MODELS,
                index=self.settings.AVAILABLE_MODELS.index(current_model)
                if current_model in self.settings.AVAILABLE_MODELS else 0,
                help="é€‰æ‹©è¦ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹",
                key=f"{key_prefix}model_selector"
            )

        with col2:
            if st.button("ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨", key=f"{key_prefix}refresh_models"):
                st.rerun()

        return selected_model

    def render_temperature_slider(self, current_temp: float, key_prefix: str = "") -> float:
        """æ¸²æŸ“æ¸©åº¦ç³»æ•°æ»‘å—"""
        temperature = st.slider(
            "ğŸŒ¡ï¸ æ¸©åº¦ç³»æ•° (Temperature)",
            min_value=0.0,
            max_value=1.0,
            value=current_temp,
            step=0.1,
            help="æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜ï¼Œå›ç­”è¶Šéšæœºï¼›å€¼è¶Šä½ï¼Œå›ç­”è¶Šç¡®å®šã€‚",
            key=f"{key_prefix}temperature_slider"
        )

        # æ˜¾ç¤ºæ¸©åº¦è§£é‡Š
        temp_explanation = self._get_temperature_explanation(temperature)
        st.caption(f"ğŸ’¡ {temp_explanation}")

        return temperature

    def render_rag_settings(self, current_top_k: int, current_search_type: str, key_prefix: str = "") -> tuple:
        """æ¸²æŸ“RAGè®¾ç½®"""
        st.subheader("ğŸ” RAGè®¾ç½®")

        col1, col2 = st.columns(2)

        with col1:
            top_k = st.slider(
                "æ£€ç´¢æ•°é‡ (Top-K)",
                min_value=1,
                max_value=10,
                value=current_top_k,
                step=1,
                help="ä»å‘é‡å­˜å‚¨ä¸­æ£€ç´¢çš„ç›¸å…³æ–‡æ¡£æ•°é‡",
                key=f"{key_prefix}top_k_slider"
            )

        with col2:
            search_type = st.selectbox(
                "æœç´¢ç±»å‹",
                options=["similarity", "mmr"],
                index=0 if current_search_type == "similarity" else 1,
                help="similarity: ç›¸ä¼¼åº¦æœç´¢; mmr: æœ€å¤§è¾¹é™…ç›¸å…³æ€§æœç´¢",
                key=f"{key_prefix}search_type_select"
            )

        # æ˜¾ç¤ºæœç´¢ç±»å‹è§£é‡Š
        search_explanation = self._get_search_type_explanation(search_type)
        st.caption(f"ğŸ’¡ {search_explanation}")

        return top_k, search_type

    def render_vector_store_status(self, is_ready: bool, stats: Optional[Dict] = None):
        """æ¸²æŸ“å‘é‡å­˜å‚¨çŠ¶æ€"""
        if is_ready:
            st.success("âœ… å‘é‡å­˜å‚¨å·²å‡†å¤‡å°±ç»ª")

            if stats:
                with st.expander("ğŸ“Š å‘é‡å­˜å‚¨ç»Ÿè®¡"):
                    col1, col2, col3 = st.columns(3)

                    with col1:
                        st.metric("æ–‡æ¡£æ•°é‡", stats.get('documents_count', 0))

                    with col2:
                        st.metric("å‘é‡æ€»æ•°", stats.get('total_vectors', 0))

                    with col3:
                        st.metric("å‘é‡ç»´åº¦", stats.get('dimension', 0))

                    if stats.get('index_path'):
                        st.caption(f"ğŸ“ ç´¢å¼•è·¯å¾„: {stats['index_path']}")

        else:
            st.warning("âš ï¸ å‘é‡å­˜å‚¨æœªå‡†å¤‡")

    def _get_temperature_explanation(self, temperature: float) -> str:
        """è·å–æ¸©åº¦ç³»æ•°è§£é‡Š"""
        if temperature < 0.3:
            return "ä½æ¸©åº¦ï¼šå›ç­”æ›´ç¡®å®šã€ä¿å®ˆ"
        elif temperature < 0.7:
            return "ä¸­ç­‰æ¸©åº¦ï¼šå¹³è¡¡ç¡®å®šæ€§å’Œåˆ›é€ æ€§"
        else:
            return "é«˜æ¸©åº¦ï¼šå›ç­”æ›´éšæœºã€æœ‰åˆ›é€ æ€§"

    def _get_search_type_explanation(self, search_type: str) -> str:
        """è·å–æœç´¢ç±»å‹è§£é‡Š"""
        if search_type == "similarity":
            return "ç›¸ä¼¼åº¦æœç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£"
        else:
            return "MMRæœç´¢ï¼šåœ¨ç›¸å…³æ€§å’Œå¤šæ ·æ€§ä¹‹é—´å–å¾—å¹³è¡¡"
```

</details>

---

## å…­ã€æµ‹è¯•ä¸éªŒè¯

### 6.1 å¤©æ°”æœåŠ¡æµ‹è¯•

```bash
# è®¾ç½®APIå¯†é’¥ï¼ˆä½¿ç”¨ä½ çš„é«˜å¾·åœ°å›¾Keyï¼‰
export WEATHER_API_KEY=your_gaode_api_key

# è¿è¡Œæµ‹è¯•
python services/weather_tools.py
```

**é¢„æœŸè¾“å‡º**ï¼š

```
ğŸŒ¤ï¸ å¤©æ°”æœåŠ¡æµ‹è¯•å¼€å§‹...
==================================================

ğŸ“ æµ‹è¯•1ï¼šè·å–åŸå¸‚ä»£ç 
------------------------------
âœ… åŒ—äº¬: 110000
âœ… ä¸Šæµ·: 310000

ğŸŒ¡ï¸ æµ‹è¯•2ï¼šè·å–å½“å‰å¤©æ°”
------------------------------

ğŸŒ åŒ—äº¬å½“å‰å¤©æ°”ï¼š
ğŸ™ï¸ **åŒ—äº¬ åŒ—äº¬å¸‚** å½“å‰å¤©æ°”

ğŸŒ¤ï¸ **å¤©æ°”çŠ¶å†µ**: æ™´
ğŸŒ¡ï¸ **æ°”æ¸©**: 15Â°C
ğŸ’¨ **é£å‘é£åŠ›**: è¥¿åŒ— â‰¤3
ğŸ’§ **æ¹¿åº¦**: 45%
ğŸ“… **å‘å¸ƒæ—¶é—´**: 2024-01-15 14:00:00

ğŸ’¡ **æ¸©é¦¨æç¤º**:
â€¢ å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå¤–å‡ºã€‚
```

### 6.2 èŠå¤©å†å²æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
python utils/chat_history.py
```

**é¢„æœŸè¾“å‡º**ï¼š

```
ğŸš€ å¼€å§‹æµ‹è¯• ChatHistoryManager ç±»...

ğŸ“‹ æµ‹è¯•1: åˆå§‹åŒ–ç®¡ç†å™¨
   âœ… åˆå§‹åŒ–æˆåŠŸï¼Œå†å²æ–‡ä»¶: /tmp/xxx.json

ğŸ’¬ æµ‹è¯•2: æ·»åŠ æ¶ˆæ¯
   âœ… æˆåŠŸæ·»åŠ  4 æ¡æ¶ˆæ¯

ğŸ“– æµ‹è¯•3: è·å–å†å²è®°å½•
   âœ… è·å–å®Œæ•´å†å²: 4 æ¡è®°å½•
   âœ… è·å–ç”¨æˆ·æ¶ˆæ¯: 2 æ¡è®°å½•
   âœ… è·å–æœ€æ–°åŠ©æ‰‹æ¶ˆæ¯: 1 æ¡è®°å½•

ğŸ” æµ‹è¯•4: æœç´¢åŠŸèƒ½
   âœ… æœç´¢ 'Python': æ‰¾åˆ° 4 æ¡ç»“æœ
   âœ… æœç´¢ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ 'é¡¹ç›®': æ‰¾åˆ° 1 æ¡ç»“æœ
   âœ… æœç´¢ 'JavaScript': æ‰¾åˆ° 0 æ¡ç»“æœ

ğŸ“Š æµ‹è¯•5: å¯¼å‡ºåŠŸèƒ½
   âœ… å¯¼å‡ºCSVå­—ç¬¦ä¸²: 234 å­—ç¬¦
   âœ… ä¿å­˜CSVæ–‡ä»¶: /tmp/xxx.csv

ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼ChatHistoryManager ç±»å·¥ä½œæ­£å¸¸ï¼
```

### 6.3 UIç»„ä»¶æµ‹è¯•

**é›†æˆæµ‹è¯•**ï¼ˆåœ¨Streamlitåº”ç”¨ä¸­ï¼‰ï¼š

```python
# test_ui_components.py
import streamlit as st
from utils.ui_components import UIComponents

st.title("UIç»„ä»¶æµ‹è¯•")

ui = UIComponents()

# æµ‹è¯•æ¸©åº¦æ»‘å—
st.subheader("æ¸©åº¦æ»‘å—")
temp = ui.render_temperature_slider(0.7)
st.write(f"é€‰æ‹©çš„æ¸©åº¦: {temp}")

# æµ‹è¯•RAGè®¾ç½®
st.subheader("RAGè®¾ç½®")
top_k, search_type = ui.render_rag_settings(5, "similarity")
st.write(f"æ£€ç´¢æ•°é‡: {top_k}, æœç´¢ç±»å‹: {search_type}")

# æµ‹è¯•å‘é‡å­˜å‚¨çŠ¶æ€
st.subheader("å‘é‡å­˜å‚¨çŠ¶æ€")
stats = {
    'documents_count': 150,
    'total_vectors': 150,
    'dimension': 1536,
    'index_path': 'data/vector_store'
}
ui.render_vector_store_status(True, stats)
```

è¿è¡Œï¼š

```bash
streamlit run test_ui_components.py
```

---

## ä¸ƒã€æœ¬ç« æ€»ç»“

### 7.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

âœ… **å¤©æ°”æŸ¥è¯¢æœåŠ¡ï¼ˆ331è¡Œï¼‰**ï¼š
- é›†æˆé«˜å¾·åœ°å›¾APIï¼Œæä¾›å®æ—¶å¤©æ°”å’Œé¢„æŠ¥åŠŸèƒ½
- åŸå¸‚ä»£ç ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘é‡å¤è¯·æ±‚
- æ™ºèƒ½å¤©æ°”å»ºè®®ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **å…³é”®æŠ€æœ¯**ï¼šAPIé›†æˆã€ç¼“å­˜ç­–ç•¥ã€æ•°æ®æ ¼å¼åŒ–

âœ… **èŠå¤©å†å²ç®¡ç†å™¨ï¼ˆ488è¡Œï¼‰**ï¼š
- JSONæŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒåŠ è½½å’Œä¿å­˜
- æœç´¢ã€è¿‡æ»¤ã€å¯¼å‡ºåŠŸèƒ½å®Œå¤‡
- UUIDç”Ÿæˆä¿è¯æ¶ˆæ¯å”¯ä¸€æ€§
- **å…³é”®æŠ€æœ¯**ï¼šæ•°æ®æŒä¹…åŒ–ã€æœç´¢ç®—æ³•ã€CSVå¯¼å‡º

âœ… **UIç»„ä»¶åº“ï¼ˆ139è¡Œï¼‰**ï¼š
- å°è£…Streamlitå¸¸ç”¨ç»„ä»¶ï¼Œé¿å…ä»£ç é‡å¤
- key_prefixæœºåˆ¶è§£å†³ç»„ä»¶keyå†²çª
- æ™ºèƒ½æç¤ºå¢å¼ºç”¨æˆ·ä½“éªŒ
- **å…³é”®æŠ€æœ¯**ï¼šç»„ä»¶åŒ–ã€çŠ¶æ€ç®¡ç†ã€å¸ƒå±€è®¾è®¡

### 7.2 ä¸å‰äº”ç« çš„å…³è”

| ç« èŠ‚ | æ ¸å¿ƒç»„ä»¶ | åœ¨ç¬¬06ç« ä¸­çš„åº”ç”¨ |
|------|----------|------------------|
| ç¬¬02ç«  | Settingsé…ç½® | WeatherServiceè¯»å–APIé…ç½®ï¼ŒChatHistoryManagerè¯»å–å†å²æ–‡ä»¶è·¯å¾„ |
| ç¬¬03ç«  | UnifiedLLMClient | UIComponentsçš„æ¨¡å‹é€‰æ‹©å™¨å±•ç¤ºå¯ç”¨æ¨¡å‹åˆ—è¡¨ |
| ç¬¬04ç«  | VectorStoreService | UIComponentsçš„å‘é‡å­˜å‚¨çŠ¶æ€å±•ç¤ºç»Ÿè®¡ä¿¡æ¯ |
| ç¬¬05ç«  | è£…é¥°å™¨å·¥å…· | å¯ä¸ºå¤©æ°”æŸ¥è¯¢ã€å†å²ç®¡ç†æ·»åŠ @error_handlerè£…é¥°å™¨ |

### 7.3 Agentå·¥å…·é›†æˆé¢„è§ˆ

**ç¬¬07ç« å°†å®ç°çš„Agentic RAG**ï¼š

```python
from models.agent import AgenticRAG
from services.weather_tools import WeatherService

# åˆå§‹åŒ–Agent
agent = AgenticRAG()

# æ³¨å†Œå¤©æ°”å·¥å…·
weather_service = WeatherService()
agent.register_tool("get_weather", weather_service.get_current_weather)

# ç”¨æˆ·æŸ¥è¯¢
user_query = "ä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"

# Agentè‡ªåŠ¨å†³å®šï¼š
# 1. è¯†åˆ«éœ€è¦å¤©æ°”ä¿¡æ¯
# 2. è°ƒç”¨get_weatherå·¥å…·
# 3. è·å–ç»“æœå¹¶å›ç­”ç”¨æˆ·
response = agent.run(user_query)
```

---

## å…«ã€ä¸‹ä¸€ç« é¢„å‘Š

**ç¬¬07ç« ï¼šAgentic RAGæ ¸å¿ƒ - ReActæ™ºèƒ½ä»£ç†çš„å®Œæ•´å®ç°**

åœ¨ç¬¬07ç« ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°æœ€æ ¸å¿ƒçš„Agentic RAGæ™ºèƒ½ä½“ï¼š

1. ç†è§£ReActæ¡†æ¶ï¼ˆReasoning + Actingï¼‰çš„å·¥ä½œåŸç†
2. å®ç°æ™ºèƒ½ä½“çš„æ¨ç†-è¡ŒåŠ¨å¾ªç¯æœºåˆ¶
3. é›†æˆå‘é‡æ£€ç´¢ã€å¤©æ°”æŸ¥è¯¢ç­‰å¤šç§å·¥å…·
4. æ„å»ºä¸‰çº§è·¯ç”±ç³»ç»Ÿï¼ˆdirect/tool_direct/reactï¼‰
5. æŒæ¡Prompt EngineeringæŠ€å·§

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„"å¤§è„‘"ï¼Œå°†å‰å…­ç« çš„æ‰€æœ‰ç»„ä»¶æ•´åˆæˆä¸€ä¸ªæ™ºèƒ½é—®ç­”ç³»ç»Ÿã€‚

---

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š
- æ•™ç¨‹ç‰ˆæœ¬ï¼šv1.0
- å¯¹åº”æºç ï¼š
  - `services/weather_tools.py`ï¼ˆ331è¡Œï¼‰
  - `utils/chat_history.py`ï¼ˆ488è¡Œï¼‰
  - `utils/ui_components.py`ï¼ˆ139è¡Œï¼‰
- æœ€åæ›´æ–°ï¼š2025-01-15
